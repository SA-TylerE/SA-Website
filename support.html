<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Support | System Alternatives</title>
  <meta name="description" content="Get help fast. Call the helpdesk or start a secure remote session with Splashtop SOS." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/base.css" />
  <link rel="stylesheet" href="/assets/css/support.css" />
  <script src="/assets/js/includes.js" defer></script>
</head>
<body>
  <!-- Shared header -->
  <div data-include="/partials/header.html"></div>

  <main>
    <!-- Hero -->
    <section class="hero hero--light hero--bg hero--enhanced support-hero">
      <div class="container hero__inner">
        <div class="hero__copy">
          <h1>Support</h1>
          <p>Need help right now? Call our helpdesk to start a secure remote session.</p>
        </div>
      </div>
    </section>

    <!-- Helpdesk -->
    <section class="section" id="helpdesk">
      <div class="container">
        <article class="card helpdesk-card">
          <div class="helpdesk-card__intro">
            <h2>Contact the Helpdesk</h2>
            <p class="lead">Speak with a tech or send us an email—whatever's convenient.</p>
          </div>

          <div class="helpdesk-actions">
            <a class="btn btn--primary" href="tel:+1-503-878-7000">Call/Text 503-878-7000</a>
            <button
              type="button"
              id="toggle-email-form"
              class="btn btn--outline"
              aria-expanded="false"
              aria-controls="email-form-mount">
              Email Helpdesk
            </button>
            <button
              type="button"
              id="toggle-ticket-form"
              class="btn btn--outline"
              aria-expanded="false"
              aria-controls="ticket-form-mount">
              Open a Ticket
            </button>
          </div>
        </article>

        <!-- MOUNT POINTS (empty until opened) -->
        <div id="email-form-mount"></div>
      </div>
    </section>

    <!-- Ticket Portal -->
    <section class="section" id="tickets">
      <div class="container">
        <!-- MOUNT POINT -->
        <div id="ticket-form-mount"></div>
      </div>
    </section>

    <!-- Remote support (Splashtop SOS) -->
    <section class="section" id="remote">
      <div class="container remote-grid">
        <article class="card download-card">
          <div class="download-header">
            <a id="download-button" class="btn btn--primary" href="#" aria-label="Download Splashtop SOS">
              <img id="platform-icon" class="platform-icon" src="" alt="" />
              <span id="button-text">Splashtop SOS</span>
            </a>
            <div class="download-meta">
              <div id="platform-message" class="platform-status">Detecting your platform…</div>
              <div class="platform-note">Auto-detected; you can choose a different platform below.</div>
            </div>
          </div>

          <div class="override-wrapper">
            <strong>Choose a different platform</strong>
            <div id="platform-buttons" class="override-group" aria-label="Manual platform selection"></div>
          </div>

          <noscript>
            <div class="notice">
              <p><strong>JavaScript is disabled.</strong> Use the direct links:</p>
              <ul>
                <li><a href="https://download.splashtop.com/sos/SplashtopSOS.exe">Windows</a></li>
                <li><a href="https://download.splashtop.com/sos/SplashtopSOS.dmg">macOS</a></li>
                <li><a href="https://play.google.com/store/apps/details?id=com.splashtop.sos">Android</a></li>
                <li><a href="https://apps.apple.com/app/splashtop-sos/id1230853703">iOS</a></li>
              </ul>
            </div>
          </noscript>
        </article>

        <div class="card howto-card">
          <h2>How it works</h2>
          <ol class="howto-steps">
            <li><strong>Download & open the app.</strong> Click the button for your platform above.</li>
            <li><strong>Provide the 9-digit code.</strong> Share the one-time SOS code with your technician.</li>
            <li><strong>We connect securely.</strong> Allow access if prompted; you can end any time.</li>
          </ol>
        </div>
      </div>
    </section>
  </main>

  <!-- Shared footer -->
  <div data-include="/partials/footer.html"></div>

  <!-- ========= Templates (cloned and inserted on demand) ========= -->
  <template id="tmpl-email-panel">
    <div class="collapsible is-open">
      <div class="card collapsible__body">
        <h3>Send details to the helpdesk</h3>
        <form id="helpdesk-email-form" class="support-form" novalidate enctype="multipart/form-data">
          <div class="form-grid">
            <label>
              <span>Name<span class="req" aria-hidden="true">*</span></span>
              <input type="text" id="hd-name" name="name" autocomplete="name" required aria-required="true">
            </label>
            <label>
              <span>Company<span class="req" aria-hidden="true">*</span></span>
              <input type="text" id="hd-company" name="company" autocomplete="organization" required aria-required="true">
            </label>
            <label class="full">
              <span>Email<span class="req" aria-hidden="true">*</span></span>
              <input type="email" id="hd-email" name="email" autocomplete="email" required aria-required="true">
            </label>
            <label class="full">
              <span>Issue<span class="req" aria-hidden="true">*</span></span>
              <textarea id="hd-issue" name="issue" rows="5" placeholder="Briefly describe the problem…" required aria-required="true"></textarea>
            </label>

            <!-- Attachments widget -->
            <div class="full attachments">
              <div class="attach-row">
                <button type="button" id="hd-add-files" class="attach-btn" title="Add up to 5 files">
                  <svg class="icon-plus" viewBox="0 0 24 24" aria-hidden="true">
                    <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 8v8M8 12h8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                  Add files
                </button>
              </div>
              <div id="hd-file-list" class="attach-list"></div>
              <input type="file" id="hd-files" name="attachments[]" multiple hidden
                     accept=".png,.jpg,.jpeg,.pdf,.txt,.log,.doc,.docx,.xlsx,.csv">
              <div class="attach-note">Up to 5 files, max 5&nbsp;MB each. Allowed: PNG, JPG, PDF, TXT/LOG, DOC/DOCX, XLSX, CSV.</div>
            </div>

            <!-- Honeypot -->
            <input type="text" id="hd-hp" name="website_honeypot" autocomplete="off" tabindex="-1" style="display:none">
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn--primary" id="hd-send">Send</button>
            <button type="button" class="btn btn--outline" id="cancel-email-form">Cancel</button>
            <span id="hd-status" class="form-status" role="status" aria-live="polite"></span>
            <span class="form-required-note"><span class="req" aria-hidden="true">*</span> Required</span>
          </div>
        </form>
      </div>
    </div>
  </template>

  <template id="tmpl-ticket-panel">
    <div class="collapsible is-open">
      <div class="card collapsible__body">
        <h3>Open / Manage a Ticket</h3>
        <section class="ticket-portal" aria-label="Ticket portal">
          <div class="tp-tabs" role="tablist" aria-label="Ticket actions">
            <button class="tp-tab tp-tab--active" data-tp="create" role="tab" aria-selected="true">Open a new ticket</button>
            <button class="tp-tab" data-tp="lookup" role="tab" aria-selected="false">Check ticket status</button>
          </div>

          <!-- Create -->
          <div class="tp-panel tp-panel--create" role="tabpanel">
            <form id="tpCreate" class="support-form" enctype="multipart/form-data" novalidate>
              <div class="form-grid">
                <label>
                  <span>Full name <span class="req" aria-hidden="true">*</span></span>
                  <input name="name" type="text" required maxlength="120" autocomplete="name">
                </label>
                <label>
                  <span>Company</span>
                  <input name="company" type="text" maxlength="190" autocomplete="organization">
                </label>
                <label>
                  <span>Email <span class="req" aria-hidden="true">*</span></span>
                  <input name="email" type="email" required maxlength="190" autocomplete="email">
                </label>
                <label>
                  <span>Phone <span class="req" aria-hidden="true">*</span></span>
                  <input name="phone" id="tp-phone" type="tel" required autocomplete="tel"
                         inputmode="tel" maxlength="14"
                         pattern="^\(\d{3}\) \d{3}-\d{4}$" placeholder="(555) 123-4567">
                </label>

                <label class="full">
                  <span>Subject <span class="req" aria-hidden="true">*</span></span>
                  <input name="subject" type="text" required maxlength="150">
                </label>
                <label class="full">
                  <span>Describe the issue <span class="req" aria-hidden="true">*</span></span>
                  <textarea name="issue" required maxlength="5000" rows="6" placeholder="What happened? When did it start? Error messages?"></textarea>
                </label>

                <!-- Attachments widget -->
                <div class="full attachments">
                  <div class="attach-row">
                    <button type="button" id="tp-add-files" class="attach-btn" title="Add up to 5 files">
                      <svg class="icon-plus" viewBox="0 0 24 24" aria-hidden="true">
                        <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
                        <path d="M12 8v8M8 12h8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                      Add files
                    </button>
                  </div>
                  <div id="tp-file-list" class="attach-list"></div>
                  <input type="file" id="tp-files" name="files[]" multiple hidden
                         accept=".png,.jpg,.jpeg,.pdf,.txt,.log,.doc,.docx,.xlsx,.csv">
                  <div class="attach-note">Up to 5 files, max 15&nbsp;MB each; no executables.</div>
                </div>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn--primary" id="tpCreateSubmit">Submit ticket</button>
                <button type="button" class="btn btn--outline" id="tpCreateCancel">Cancel</button>
                <span class="tp-hint" id="tpCreateHint" role="status" aria-live="polite"></span>
                <span class="form-required-note"><span class="req" aria-hidden="true">*</span> Required</span>
              </div>
            </form>
          </div>

          <!-- Lookup -->
          <div class="tp-panel tp-panel--lookup" role="tabpanel" hidden aria-hidden="true">
            <form id="tpLookupStart" class="support-form" novalidate>
              <div class="form-grid">
                <label class="full">
                  <span>Requester email <span class="req" aria-hidden="true">*</span></span>
                  <input name="email" type="email" required maxlength="190">
                </label>
                <label class="full">
                  <span>Ticket number</span>
                  <input name="ticket_number" type="text" maxlength="20" placeholder="If you have it">
                </label>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn btn--primary">Email me a secure link</button>
                <button type="button" class="btn btn--outline" id="tpLookupCancel">Cancel</button>
                <span class="tp-hint" id="tpLookupHint" role="status" aria-live="polite"></span>
                <span class="form-required-note"><span class="req" aria-hidden="true">*</span> Required</span>
              </div>
            </form>

            <div id="tpLookupResult" class="tp-result" hidden>
              <h3 class="tp-result__title">Your ticket</h3>
              <div class="tp-ticket" id="tpTicketCard"></div>

              <form id="tpAddComment" class="support-form tp-comment" novalidate>
                <div class="form-grid">
                  <label class="full">
                    <span>Add a public comment (optional)</span>
                    <textarea name="message" rows="4" maxlength="5000"></textarea>
                  </label>
                </div>
                <div class="form-actions">
                  <button type="submit" class="btn">Post comment</button>
                  <span class="tp-hint" id="tpCommentHint" role="status" aria-live="polite"></span>
                </div>
              </form>
            </div>
          </div>
        </section>
      </div>
    </div>
  </template>

  <!-- ========================== Scripts ========================== -->
  <script>
    /* ===== Splashtop platform detection (unchanged) ===== */
    document.addEventListener("DOMContentLoaded", function () {
      const downloadBtn = document.getElementById("download-button");
      const platformMsg = document.getElementById("platform-message");
      const platformIcon = document.getElementById("platform-icon");
      const buttonText = document.getElementById("button-text");
      const platformBtnsContainer = document.getElementById("platform-buttons");

      const downloads = {
        windows:{name:"Windows",url:"https://download.splashtop.com/sos/SplashtopSOS.exe",icon:"https://img.icons8.com/ios-filled/50/000000/windows8.png"},
        mac:{name:"macOS",url:"https://download.splashtop.com/sos/SplashtopSOS.dmg",icon:"https://img.icons8.com/ios-filled/50/000000/mac-os.png"},
        android:{name:"Android",url:"https://play.google.com/store/apps/details?id=com.splashtop.sos",icon:"https://img.icons8.com/ios-filled/50/000000/android-os.png"},
        ios:{name:"iOS",url:"https://apps.apple.com/app/splashtop-sos/id1230853703",icon:"https://img.icons8.com/ios-filled/50/000000/ios-logo.png"}
      };

      function detectOS(){
        const ua = navigator.userAgent || navigator.vendor || window.opera;
        if (/windows/i.test(ua)) return "windows";
        if (/macintosh|mac os x/i.test(ua)) return "mac";
        if (/android/i.test(ua)) return "android";
        if (/iphone|ipad|ipod/i.test(ua)) return "ios";
        return "unknown";
      }
      function markSelected(osKey){
        document.querySelectorAll('.override-download-btn')
          .forEach(b => b.classList.toggle('selected', b.dataset.key === osKey));
      }
      function updateDownload(osKey, manual = false){
        const p = downloads[osKey]; if (!p) return;
        downloadBtn.href = p.url;
        platformIcon.src = p.icon;
        platformIcon.alt = p.name + " icon";
        buttonText.textContent = "Splashtop SOS";
        platformMsg.textContent = `Download the ${p.name} version${manual ? " (selected manually)" : ""}.`;
        downloadBtn.style.display = "inline-flex";
        markSelected(osKey);
      }
      function buildOverrideButtons(){
        for (let key in downloads){
          const p = downloads[key];
          const btn = document.createElement("button");
          btn.className = "override-download-btn";
          btn.type = "button";
          btn.dataset.key = key;
          btn.innerHTML = `<img src="${p.icon}" alt="${p.name}"> ${p.name}`;
          btn.addEventListener("click", () => updateDownload(key, true));
          platformBtnsContainer.appendChild(btn);
        }
      }

      const detectedOS = detectOS();
      buildOverrideButtons();
      if (downloads[detectedOS]) updateDownload(detectedOS);
      else { platformMsg.textContent = "We couldn't detect your platform. Please choose one below."; downloadBtn.style.display = "none"; }
    });

    const API = (p) => `${window.location.origin}/${String(p).replace(/^\/+/, '')}`;

    /* ===== Attachment widget factory (shared) ===== */
    function createIngestWorker(){
      const src = `
        const jobs = new Map();
        self.onmessage = (e)=>{
          const {cmd, id, file, chunk=524288} = e.data||{};
          if (cmd==='ingest'){
            jobs.set(id, {cancel:false});
            try{
              const reader = new FileReaderSync();
              let offset = 0, total = file.size||1;
              while(offset < total){
                const job = jobs.get(id);
                if (!job || job.cancel){ postMessage({id,type:'aborted'}); jobs.delete(id); return; }
                const end = Math.min(offset+chunk, total);
                reader.readAsArrayBuffer(file.slice(offset,end));
                offset = end;
                postMessage({id,type:'progress',pct:Math.round((offset/total)*100)});
              }
              postMessage({id,type:'done'});
              jobs.delete(id);
            }catch(err){
              postMessage({id,type:'error',message:String(err&&err.message||err)});
              jobs.delete(id);
            }
          }else if(cmd==='abort'){
            const j = jobs.get(id); if (j) j.cancel = true;
          }
        };
      `;
      const blob = new Blob([src], {type:'application/javascript'});
      const url  = URL.createObjectURL(blob);
      const w    = new Worker(url);
      w._revokeURL = ()=> URL.revokeObjectURL(url);
      return w;
    }

    function setupAttachmentWidget({ addBtnId, inputId, listId, limits }){
      const addBtn = document.getElementById(addBtnId);
      const input  = document.getElementById(inputId);
      const listEl = document.getElementById(listId);
      const ready = [];
      const active = new Map();
      const q = [];
      let busy = false;
      let worker = null;
      const MAX_FILES = limits.maxFiles;
      const MAX_SIZE  = limits.maxSize;
      const allowed   = limits.allowed;
      const fmtMB = n => (n/(1024*1024)).toFixed(2)+' MB';
      const sig = f => `${f.name}|${f.size}|${f.lastModified}`;

      function setBtnState(){
        const count = ready.length + active.size;
        addBtn.disabled = count >= MAX_FILES;
        addBtn.title = addBtn.disabled ? `Limit reached (${MAX_FILES} files)` : `Add up to ${MAX_FILES} files`;
      }
      function chipFor(file, id){
        const chip = document.createElement('span');
        chip.className = 'file-chip is-loading';
        chip.dataset.id = id;
        chip.innerHTML = `
          <span class="file-chip__name" title="${file.name}">${file.name}</span>
          <span class="file-chip__size">(${fmtMB(file.size)})</span>
          <span class="file-chip__bar" aria-hidden="true"><span data-fill style="width:0%"></span></span>
          <span class="file-chip__pct" data-pct>0%</span>
          <button class="file-chip__remove" type="button" aria-label="Remove ${file.name}">×</button>
        `;
        listEl.appendChild(chip);
        return {
          chip,
          fill: chip.querySelector('[data-fill]'),
          pct: chip.querySelector('[data-pct]'),
          removeBtn: chip.querySelector('.file-chip__remove')
        };
      }
      function markReady(id){
        const entry = active.get(id);
        if (!entry) return;
        entry.els.fill.style.width = '100%';
        entry.els.pct.textContent = '100%';
        entry.els.chip.classList.remove('is-loading');
        entry.els.chip.classList.add('is-ready');
        ready.push({id, file: entry.file});
        active.delete(id);
        setBtnState();
        pump();
      }
      function removeId(id){
        const entry = active.get(id);
        if (entry){
          if (entry.mode === 'worker' && worker){
            try { worker.postMessage({cmd:'abort', id}); } catch {}
          }
          try { entry.els.chip.remove(); } catch {}
          active.delete(id);
        } else {
          const idx = ready.findIndex(r => r.id === id);
          if (idx >= 0){
            try {
              const el = listEl.querySelector(`.file-chip[data-id="${id}"]`);
              if (el) el.remove();
            } catch {}
            ready.splice(idx,1);
          }
        }
        setBtnState();
        pump();
      }
      listEl.addEventListener('click', (e)=>{
        const btn = e.target.closest('.file-chip__remove');
        if (!btn) return;
        const chip = btn.closest('.file-chip');
        if (!chip) return;
        removeId(chip.dataset.id);
      });
      function ensureWorker(){
        if (worker) return;
        try {
          worker = createIngestWorker();
          worker.onmessage = (ev)=>{
            const {id, type, pct} = ev.data || {};
            const entry = active.get(id);
            if (!entry) return;
            if (type === 'progress'){
              entry.els.fill.style.width = pct + '%';
              entry.els.pct.textContent  = pct + '%';
            } else if (type === 'done'){
              busy = false; markReady(id);
            } else if (type === 'aborted'){
              busy = false; removeId(id);
            } else if (type === 'error'){
              busy = false; removeId(id);
            }
          };
          worker.onerror = ()=>{ busy = false; };
        } catch { worker = null; }
      }
      function pump(){
        if (busy || q.length === 0) return;
        const job = q.shift();
        const entry = active.get(job.id);
        if (!entry) { pump(); return; }
        if (worker){
          busy = true; entry.state = 'working'; entry.mode = 'worker';
          setTimeout(()=> {
            try { worker.postMessage({cmd:'ingest', id: job.id, file: job.file, chunk: 512*1024}); }
            catch { busy = false; removeId(job.id); }
          }, 0);
        } else {
          const dur = Math.max(600, Math.min(2200, 450 + (job.file.size/(1024*1024))*350));
          const t0 = performance.now();
          entry.state = 'working'; entry.mode = 'sim'; busy = true;
          const tick = (now)=>{
            if (!active.has(job.id)) { busy=false; pump(); return; }
            const t = Math.min(1, (now - t0) / dur);
            const pct = Math.round((1 - Math.pow(1 - t, 3)) * 100);
            entry.els.fill.style.width = pct + '%';
            entry.els.pct.textContent  = pct + '%';
            if (t < 1){ requestAnimationFrame(tick); }
            else { busy = false; markReady(job.id); }
          };
          requestAnimationFrame(tick);
        }
      }
      function addFile(file){
        if (ready.length + active.size >= MAX_FILES) return;
        if (file.size > MAX_SIZE) { alert(`${file.name} is larger than ${(MAX_SIZE/1048576).toFixed(0)} MB.`); return; }
        const okType = allowed.includes(file.type) || /\.(png|jpe?g|pdf|txt|log|docx?|xlsx|csv)$/i.test(file.name);
        if (!okType) { alert(`${file.name} is not an allowed file type.`); return; }
        const signature = sig(file);
        for (const [, v] of active) if (sig(v.file) === signature) return;
        if (ready.some(r => sig(r.file) === signature)) return;
        const id = (self.crypto?.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random().toString(16).slice(2)}`);
        const els = chipFor(file, id);
        active.set(id, { file, els, state:'queued', mode:'pending' });
        setBtnState();
        setTimeout(()=> { ensureWorker(); q.push({ id, file }); pump(); }, 0);
      }
      function addMany(files){ files.forEach((f, i)=> setTimeout(()=> addFile(f), i*40)); }
      addBtn.addEventListener('click', ()=> input.click());
      input.addEventListener('change', ()=>{
        const files = Array.from(input.files || []);
        input.value = '';
        if (!files.length) return;
        addMany(files);
      });
      function reset(){
        if (worker){
          active.forEach((_, id)=> { try { worker.postMessage({cmd:'abort', id}); } catch {} });
        }
        listEl.querySelectorAll('.file-chip').forEach(el => el.remove());
        active.clear();
        ready.length = 0; q.length = 0; busy = false; setBtnState();
      }
      return { get: ()=> ready.map(r => r.file), reset };
    }

    /* ===== Panel mount/unmount helpers ===== */
    const mounts = {
      email: document.getElementById('email-form-mount'),
      ticket: document.getElementById('ticket-form-mount')
    };
    const tmpls = {
      email: document.getElementById('tmpl-email-panel'),
      ticket: document.getElementById('tmpl-ticket-panel')
    };

    function unmount(name){
      const m = mounts[name];
      if (!m) return;
      m.innerHTML = ''; // removes from DOM => no spacing artifacts
    }
    function isMounted(name){
      const m = mounts[name];
      return m && m.firstElementChild;
    }
    function mount(name){
      const m = mounts[name], t = tmpls[name];
      if (!m || !t || isMounted(name)) return null;
      const node = t.content.cloneNode(true);
      m.appendChild(node);
      return m.firstElementChild; // root of the mounted panel
    }

    /* ===== Email panel wiring (mount/unmount) ===== */
    (function(){
      const toggleBtn = document.getElementById('toggle-email-form');
      let widget = null; // attachments instance
      function wireEmailPanel(){
        const root = mounts.email.firstElementChild;
        if (!root) return;
        const form      = root.querySelector('#helpdesk-email-form');
        const cancelBtn = root.querySelector('#cancel-email-form');
        const statusEl  = root.querySelector('#hd-status');
        const sendBtn   = root.querySelector('#hd-send');

        let fadeTimer=null, resetTimer=null;
        const set = (cls, html)=>{ if(fadeTimer)clearTimeout(fadeTimer); if(resetTimer)clearTimeout(resetTimer); statusEl.className=`form-status ${cls} is-visible`; statusEl.innerHTML=html; };
        const ok  = m=>{ set('form-status--ok', `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20 6L9 17l-5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>${m}`); fadeTimer=setTimeout(()=>{ statusEl.classList.remove('is-visible'); resetTimer=setTimeout(()=>{ statusEl.className='form-status'; statusEl.textContent=''; },300);},7000); };
        const err = m=> set('form-status--error', m);
        const prog= ()=> set('form-status--progress', `<span class="spinner" aria-hidden="true"></span>Sending...`);
        const clear= ()=>{ statusEl.classList.remove('is-visible'); resetTimer=setTimeout(()=>{ statusEl.className='form-status'; statusEl.textContent=''; },250); };

        widget = setupAttachmentWidget({
          addBtnId:'hd-add-files', inputId:'hd-files', listId:'hd-file-list',
          limits:{ maxFiles:5, maxSize:5*1024*1024, allowed:['image/png','image/jpeg','application/pdf','text/plain','application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','text/csv']}
        });

        cancelBtn.addEventListener('click', ()=>{ form.reset(); widget.reset(); clear(); unmount('email'); toggleBtn.setAttribute('aria-expanded','false'); });

        form.addEventListener('submit', async (e)=>{
          e.preventDefault(); clear();
          if (!form.reportValidity()){ err('Please complete all required fields.'); return; }
          sendBtn.disabled = true; cancelBtn.disabled = true; root.querySelector('#hd-add-files').disabled = true; prog();
          const fd = new FormData(form); for (const f of widget.get()) fd.append('attachments[]', f, f.name);
          try{
            const resp = await fetch(API('api/helpdesk.php'), { method:'POST', body: fd });
            const data = await resp.json();
            if (!resp.ok || !data?.ok) throw new Error(data?.error || 'Send failed');
            ok('Sent'); form.reset(); widget.reset();
          }catch(e2){ err('Send failed — please try again.'); }
          finally{ sendBtn.disabled=false; cancelBtn.disabled=false; root.querySelector('#hd-add-files').disabled=false; }
        });
      }

      toggleBtn.addEventListener('click', ()=>{
        const open = isMounted('email');
        if (open){ unmount('email'); toggleBtn.setAttribute('aria-expanded','false'); return; }
        // open email => close ticket first
        unmount('ticket');
        document.getElementById('toggle-ticket-form').setAttribute('aria-expanded','false');
        mount('email'); wireEmailPanel(); toggleBtn.setAttribute('aria-expanded','true');
      });

      // expose for ticket to close it if needed
      window.saPanels = window.saPanels || {};
      window.saPanels.email = { isOpen: ()=> isMounted('email'), close: ()=>{ if(isMounted('email')){ unmount('email'); toggleBtn.setAttribute('aria-expanded','false'); } } };
    })();

    /* ===== Ticket panel wiring (mount/unmount) ===== */
    (function(){
      const toggleBtn = document.getElementById('toggle-ticket-form');

      function wireTicketPanel(){
        const root = mounts.ticket.firstElementChild;
        if (!root) return;
        const portal = root.querySelector('.ticket-portal');

        // Tabs (no scrolling)
        portal.querySelectorAll('.tp-tab').forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            portal.querySelectorAll('.tp-tab').forEach(b=>b.classList.remove('tp-tab--active'));
            e.currentTarget.classList.add('tp-tab--active');
            const tgt = e.currentTarget.getAttribute('data-tp');
            portal.querySelectorAll('.tp-panel').forEach(p => p.hidden = !p.classList.contains(`tp-panel--${tgt}`));
          });
        });

        // Phone mask (same as contact)
        (function initPhoneMask(){
          const input = portal.querySelector('#tp-phone'); if (!input) return;
          function f(d){d=d.slice(0,10); if(!d) return ''; if(d.length<4) return `(${d}`; if(d.length<7) return `(${d.slice(0,3)}) ${d.slice(3)}`; return `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`;}
          const dc=(s,p)=>{let c=0;for(let i=0;i<p&&i<s.length;i++) if(/\d/.test(s[i])) c++;return c;}
          const cp=(s,i)=>{if(i<=0)return 0;let c=0;for(let k=0;k<s.length;k++){if(/\d/.test(s[k])) c++; if(c>=i) return k+1}return s.length}
          const val=(v)=>{ if(v && !/^\(\d{3}\) \d{3}-\d{4}$/.test(v)) input.setCustomValidity('Please enter a full 10-digit US number, e.g. (555) 123-4567.'); else input.setCustomValidity(''); }
          input.addEventListener('input',()=>{const ov=input.value,op=input.selectionStart??ov.length,db=dc(ov,op);const nd=ov.replace(/\D/g,'').slice(0,10);const nv=f(nd);const np=cp(nv,db); if(nv!==ov){input.value=nv; queueMicrotask(()=>input.setSelectionRange(np,np));} val(input.value);});
          input.addEventListener('blur',()=>val(input.value));
          input.addEventListener('paste',(e)=>{e.preventDefault();const d=(e.clipboardData||window.clipboardData).getData('text').replace(/\D/g,'').slice(0,10); input.value=f(d); const end=input.value.length; input.setSelectionRange(end,end); val(input.value);});
        })();

        // Attachments (ticket)
        const tpWidget = setupAttachmentWidget({
          addBtnId: 'tp-add-files',
          inputId : 'tp-files',
          listId  : 'tp-file-list',
          limits  : { maxFiles:5, maxSize:15*1024*1024, allowed:['image/png','image/jpeg','application/pdf','text/plain','application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','text/csv'] }
        });

        // Create ticket
        const createForm = portal.querySelector('#tpCreate');
        const createHint = portal.querySelector('#tpCreateHint');
        const createBtn  = portal.querySelector('#tpCreateSubmit');

        createForm.addEventListener('submit', async (e)=>{
          e.preventDefault(); createHint.textContent=''; createBtn.disabled=true;
          const fd = new FormData(createForm);
          const need = ['name','email','phone','subject','issue'];
          for (const n of need){ if (!(fd.get(n)||'').toString().trim()){ createHint.textContent='Please fill out all required fields.'; createBtn.disabled=false; return; } }
          for (const f of tpWidget.get()) fd.append('files[]', f, f.name);
          try{
            const res = await fetch('/api/tickets/create.php',{method:'POST', body:fd, credentials:'same-origin'});
            const data = await res.json();
            if (!res.ok) throw new Error(data?.error || 'Submission failed.');
            createHint.textContent = `Ticket created! #${data.public_ref}. Check your email for confirmation.`;
            createForm.reset(); tpWidget.reset();
          } catch(err){ createHint.textContent = err.message || 'Error creating ticket.'; }
          finally{ createBtn.disabled=false; }
        });

        // Cancel buttons
        portal.querySelector('#tpCreateCancel')?.addEventListener('click', ()=>{
          portal.querySelector('#tpCreate')?.reset(); tpWidget.reset(); unmount('ticket'); toggleBtn.setAttribute('aria-expanded','false');
        });
        portal.querySelector('#tpLookupCancel')?.addEventListener('click', ()=>{
          portal.querySelector('#tpLookupStart')?.reset(); unmount('ticket'); toggleBtn.setAttribute('aria-expanded','false');
        });

        // Lookup start
        const lookupForm = portal.querySelector('#tpLookupStart');
        const lookupHint = portal.querySelector('#tpLookupHint');
        lookupForm?.addEventListener('submit', async (e)=>{
          e.preventDefault(); const fd = new FormData(lookupForm); lookupHint.textContent='';
          try{
            const res = await fetch('/api/tickets/lookup_start.php',{method:'POST', body:fd, credentials:'same-origin'});
            const data = await res.json();
            if (!res.ok) throw new Error(data?.error || 'Request failed.');
            lookupHint.textContent = 'If that email exists for a ticket, a secure link has been sent.';
            lookupForm.reset();
          }catch(err){ lookupHint.textContent = err.message || 'Error sending link.'; }
        });
      }

      toggleBtn.addEventListener('click', ()=>{
        const open = isMounted('ticket');
        if (open){ unmount('ticket'); toggleBtn.setAttribute('aria-expanded','false'); return; }
        // open ticket => close email first
        unmount('email');
        document.getElementById('toggle-email-form').setAttribute('aria-expanded','false');
        mount('ticket'); wireTicketPanel(); toggleBtn.setAttribute('aria-expanded','true');
      });

      // expose for email to close it if needed
      window.saPanels = window.saPanels || {};
      window.saPanels.ticket = { isOpen: ()=> isMounted('ticket'), close: ()=>{ if(isMounted('ticket')){ unmount('ticket'); toggleBtn.setAttribute('aria-expanded','false'); } } };

      // Handle deep-link token (?tkn=...)
      (async ()=>{
        const url = new URL(window.location.href);
        const token = url.searchParams.get('tkn');
        if (!token) return;
        unmount('email'); document.getElementById('toggle-email-form').setAttribute('aria-expanded','false');
        mount('ticket'); wireTicketPanel(); toggleBtn.setAttribute('aria-expanded','true');
        const portal = mounts.ticket.querySelector('.ticket-portal');
        portal.querySelector('.tp-tab[data-tp="lookup"]')?.click();
        try{
          const res = await fetch('/api/tickets/lookup_fetch.php?tkn='+encodeURIComponent(token), {credentials:'same-origin'});
          const data = await res.json();
          if (!res.ok) throw new Error(data?.error || 'Could not load ticket.');
          portal.querySelector('#tpLookupResult').hidden = false;
          portal.querySelector('#tpTicketCard').innerHTML = `
            <div class="tp-card-line"><strong>Ticket #</strong> ${data.public_ref}</div>
            <div class="tp-card-line"><strong>Subject</strong> ${data.subject}</div>
            <div class="tp-card-line"><strong>Status</strong> ${data.status}</div>
            <div class="tp-card-line"><strong>Last Update</strong> ${data.updated_at}</div>
            <div class="tp-thread">
              ${data.thread.map(m=>`
                <div class="tp-msg">
                  <div class="tp-msg-meta">${m.when} — ${m.author}${m.public?'':' (private)'}</div>
                  <div class="tp-msg-body">${m.body_html}</div>
                </div>`).join('')}
            </div>`;
          portal.querySelector('#tpAddComment')?.addEventListener('submit', async (e)=>{
            e.preventDefault(); const hint = portal.querySelector('#tpCommentHint'); hint.textContent='';
            const fd = new FormData(e.currentTarget); fd.append('tkn', token);
            try{
              const res = await fetch('/api/tickets/add_comment.php',{method:'POST', body:fd, credentials:'same-origin'});
              const out = await res.json();
              if (!res.ok) throw new Error(out?.error || 'Failed to post comment.');
              hint.textContent = 'Comment posted.'; e.currentTarget.reset();
            }catch(err){ hint.textContent = err.message || 'Error posting comment.'; }
          });
        }catch(_e){ /* silent */ }
      })();
    })();
  </script>
</body>
</html>
