<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Support | System Alternatives</title>
  <meta name="description" content="Get help fast. Call the helpdesk or start a secure remote session with Splashtop SOS." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/base.css" />
  <link rel="stylesheet" href="/assets/css/support.css" />
  <script src="/assets/js/includes.js" defer></script>
</head>
<body>
  <!-- Shared header -->
  <div data-include="/partials/header.html"></div>

  <main>
    <!-- Hero -->
    <section class="hero hero--light hero--bg hero--enhanced support-hero">
      <div class="container hero__inner">
        <div class="hero__copy">
          <h1>Support</h1>
          <p>Need help right now? Call our helpdesk to start a secure remote session.</p>
        </div>
      </div>
    </section>

    <!-- Helpdesk -->
    <section class="section" id="helpdesk">
      <div class="container">
        <article class="card helpdesk-card">
          <div class="helpdesk-card__intro">
            <h2>Contact the Helpdesk</h2>
            <p class="lead">Speak with a tech or send us an email—whatever's convenient.</p>
          </div>

          <div class="helpdesk-actions">
            <a class="btn btn--primary" href="tel:+1-503-878-7000">Call/Text 503-878-7000</a>
            <button
              type="button"
              id="toggle-email-form"
              class="btn btn--outline"
              aria-expanded="false"
              aria-controls="email-form-mount">
              Email Helpdesk
            </button>
            <button
              type="button"
              id="toggle-ticket-form"
              class="btn btn--outline"
              aria-expanded="false"
              aria-controls="ticket-form-mount">
              Open a Ticket
            </button>
          </div>
        </article>

        <!-- Email form mount (empty until opened) -->
        <div id="email-form-mount"></div>
      </div>
    </section>

    <!-- Ticket mount -->
    <section class="section" id="tickets">
      <div class="container">
        <div id="ticket-form-mount"></div>
      </div>
    </section>

    <!-- Remote support (Splashtop SOS) -->
    <section class="section" id="remote">
      <div class="container remote-grid">
        <article class="card download-card">
          <div class="download-header">
            <a id="download-button" class="btn btn--primary" href="#" aria-label="Download Splashtop SOS">
              <img id="platform-icon" class="platform-icon" src="" alt="" />
              <span id="button-text">Splashtop SOS</span>
            </a>
            <div class="download-meta">
              <div id="platform-message" class="platform-status">Detecting your platform…</div>
              <div class="platform-note">Auto-detected; you can choose a different platform below.</div>
            </div>
          </div>

          <div class="override-wrapper">
            <strong>Choose a different platform</strong>
            <div id="platform-buttons" class="override-group" aria-label="Manual platform selection"></div>
          </div>

          <noscript>
            <div class="notice">
              <p><strong>JavaScript is disabled.</strong> Use the direct links:</p>
              <ul>
                <li><a href="https://download.splashtop.com/sos/SplashtopSOS.exe">Windows</a></li>
                <li><a href="https://download.splashtop.com/sos/SplashtopSOS.dmg">macOS</a></li>
                <li><a href="https://play.google.com/store/apps/details?id=com.splashtop.sos">Android</a></li>
                <li><a href="https://apps.apple.com/app/splashtop-sos/id1230853703">iOS</a></li>
              </ul>
            </div>
          </noscript>
        </article>

        <div class="card howto-card">
          <h2>How it works</h2>
          <ol class="howto-steps">
            <li><strong>Download & open the app.</strong> Click the button for your platform above.</li>
            <li><strong>Provide the 9-digit code.</strong> Share the one-time SOS code with your technician.</li>
            <li><strong>We connect securely.</strong> Allow access if prompted; you can end any time.</li>
          </ol>
        </div>
      </div>
    </section>
  </main>

  <!-- Shared footer -->
  <div data-include="/partials/footer.html"></div>

  <!-- Scripts -->
  <script>
    /* ===== Splashtop platform detection (unchanged) ===== */
    document.addEventListener("DOMContentLoaded", function () {
      const downloadBtn = document.getElementById("download-button");
      const platformMsg = document.getElementById("platform-message");
      const platformIcon = document.getElementById("platform-icon");
      const buttonText = document.getElementById("button-text");
      const platformBtnsContainer = document.getElementById("platform-buttons");

      const downloads = {
        windows:{name:"Windows",url:"https://download.splashtop.com/sos/SplashtopSOS.exe",icon:"https://img.icons8.com/ios-filled/50/000000/windows8.png"},
        mac:{name:"macOS",url:"https://download.splashtop.com/sos/SplashtopSOS.dmg",icon:"https://img.icons8.com/ios-filled/50/000000/mac-os.png"},
        android:{name:"Android",url:"https://play.google.com/store/apps/details?id=com.splashtop.sos",icon:"https://img.icons8.com/ios-filled/50/000000/android-os.png"},
        ios:{name:"iOS",url:"https://apps.apple.com/app/splashtop-sos/id1230853703",icon:"https://img.icons8.com/ios-filled/50/000000/ios-logo.png"}
      };

      function detectOS(){
        const ua = navigator.userAgent || navigator.vendor || window.opera;
        if (/windows/i.test(ua)) return "windows";
        if (/macintosh|mac os x/i.test(ua)) return "mac";
        if (/android/i.test(ua)) return "android";
        if (/iphone|ipad|ipod/i.test(ua)) return "ios";
        return "unknown";
      }
      function markSelected(osKey){
        document.querySelectorAll('.override-download-btn')
          .forEach(b => b.classList.toggle('selected', b.dataset.key === osKey));
      }
      function updateDownload(osKey, manual = false){
        const p = downloads[osKey]; if (!p) return;
        downloadBtn.href = p.url;
        platformIcon.src = p.icon;
        platformIcon.alt = p.name + " icon";
        buttonText.textContent = "Splashtop SOS";
        platformMsg.textContent = `Download the ${p.name} version${manual ? " (selected manually)" : ""}.`;
        downloadBtn.style.display = "inline-flex";
        markSelected(osKey);
      }
      function buildOverrideButtons(){
        for (let key in downloads){
          const p = downloads[key];
          const btn = document.createElement("button");
          btn.className = "override-download-btn";
          btn.type = "button";
          btn.dataset.key = key;
          btn.innerHTML = `<img src="${p.icon}" alt="${p.name}"> ${p.name}`;
          btn.addEventListener("click", () => updateDownload(key, true));
          platformBtnsContainer.appendChild(btn);
        }
      }

      const detectedOS = detectOS();
      buildOverrideButtons();
      if (downloads[detectedOS]) updateDownload(detectedOS);
      else { platformMsg.textContent = "We couldn't detect your platform. Please choose one below."; downloadBtn.style.display = "none"; }
    });

    const API = (p) => `${window.location.origin}/${String(p).replace(/^\/+/, '')}`;

    /* ===== Inline worker used by the attachments widget ===== */
    function createIngestWorker(){
      const src = `
        const jobs = new Map();
        self.onmessage = (e)=>{
          const {cmd, id, file, chunk=524288} = e.data||{};
          if (cmd==='ingest'){
            jobs.set(id, {cancel:false});
            try{
              const reader = new FileReaderSync();
              let offset = 0, total = file.size||1;
              while(offset < total){
                const job = jobs.get(id);
                if (!job || job.cancel){ postMessage({id,type:'aborted'}); jobs.delete(id); return; }
                const end = Math.min(offset+chunk, total);
                reader.readAsArrayBuffer(file.slice(offset,end));
                offset = end;
                postMessage({id,type:'progress',pct:Math.round((offset/total)*100)});
              }
              postMessage({id,type:'done'});
              jobs.delete(id);
            }catch(err){
              postMessage({id,type:'error',message:String(err && err.message || err)});
              jobs.delete(id);
            }
          }else if(cmd==='abort'){
            const j = jobs.get(id); if (j) j.cancel = true;
          }
        };
      `;
      const blob = new Blob([src], {type:'application/javascript'});
      const url  = URL.createObjectURL(blob);
      const w    = new Worker(url);
      w._revokeURL = ()=> URL.revokeObjectURL(url);
      return w;
    }

    /* ===== Shared attachments widget (email + ticket) ===== */
    function setupAttachmentWidget({ addBtnId, inputId, listId, limits }){
      const addBtn = document.getElementById(addBtnId);
      const input  = document.getElementById(inputId);
      const listEl = document.getElementById(listId);

      const ready = [];
      const active = new Map();
      const q = [];
      let busy = false;
      let worker = null;

      const MAX_FILES = limits.maxFiles;
      const MAX_SIZE  = limits.maxSize;
      const allowed   = limits.allowed;

      const fmtMB = n => (n/(1024*1024)).toFixed(2)+' MB';
      const sig = f => `${f.name}|${f.size}|${f.lastModified}`;

      function setBtnState(){
        const count = ready.length + active.size;
        addBtn.disabled = count >= MAX_FILES;
        addBtn.title = addBtn.disabled ? `Limit reached (${MAX_FILES} files)` : `Add up to ${MAX_FILES} files`;
      }

      function chipFor(file, id){
        const chip = document.createElement('span');
        chip.className = 'file-chip is-loading';
        chip.dataset.id = id;
        chip.innerHTML = `
          <span class="file-chip__name" title="${file.name}">${file.name}</span>
          <span class="file-chip__size">(${fmtMB(file.size)})</span>
          <span class="file-chip__bar" aria-hidden="true"><span data-fill style="width:0%"></span></span>
          <span class="file-chip__pct" data-pct>0%</span>
          <button class="file-chip__remove" type="button" aria-label="Remove ${file.name}">×</button>
        `;
        listEl.appendChild(chip);
        return {
          chip,
          fill: chip.querySelector('[data-fill]'),
          pct: chip.querySelector('[data-pct]'),
          removeBtn: chip.querySelector('.file-chip__remove')
        };
      }

      function markReady(id){
        const entry = active.get(id);
        if (!entry) return;
        entry.els.fill.style.width = '100%';
        entry.els.pct.textContent = '100%';
        entry.els.chip.classList.remove('is-loading');
        entry.els.chip.classList.add('is-ready');
        ready.push({id, file: entry.file});
        active.delete(id);
        setBtnState();
        pump();
      }

      function removeId(id){
        const entry = active.get(id);
        if (entry){
          if (entry.mode === 'worker' && worker){
            try { worker.postMessage({cmd:'abort', id}); } catch {}
          }
          try { entry.els.chip.remove(); } catch {}
          active.delete(id);
        } else {
          const idx = ready.findIndex(r => r.id === id);
          if (idx >= 0){
            try{
              const el = listEl.querySelector(`.file-chip[data-id="${id}"]`);
              if (el) el.remove();
            }catch{}
            ready.splice(idx,1);
          }
        }
        setBtnState();
        pump();
      }

      listEl.addEventListener('click', (e)=>{
        const btn = e.target.closest('.file-chip__remove');
        if (!btn) return;
        const chip = btn.closest('.file-chip');
        if (!chip) return;
        removeId(chip.dataset.id);
      });

      function ensureWorker(){
        if (worker) return;
        try {
          worker = createIngestWorker();
          worker.onmessage = (ev)=>{
            const {id, type, pct} = ev.data || {};
            const entry = active.get(id);
            if (!entry) return;
            if (type === 'progress'){
              entry.els.fill.style.width = pct + '%';
              entry.els.pct.textContent  = pct + '%';
            } else if (type === 'done'){
              busy = false; markReady(id);
            } else if (type === 'aborted'){
              busy = false; removeId(id);
            } else if (type === 'error'){
              busy = false; removeId(id);
            }
          };
          worker.onerror = ()=>{ busy = false; };
        } catch { worker = null; }
      }

      function pump(){
        if (busy || q.length === 0) return;
        const job = q.shift();
        const entry = active.get(job.id);
        if (!entry) { pump(); return; }
        if (worker){
          busy = true; entry.state = 'working'; entry.mode = 'worker';
          setTimeout(()=> {
            try { worker.postMessage({cmd:'ingest', id: job.id, file: job.file, chunk: 512*1024}); }
            catch { busy = false; removeId(job.id); }
          }, 0);
        } else {
          const dur = Math.max(600, Math.min(2200, 450 + (job.file.size/(1024*1024))*350));
          const t0 = performance.now();
          entry.state = 'working'; entry.mode = 'sim'; busy = true;
          const tick = (now)=>{
            if (!active.has(job.id)) { busy=false; pump(); return; }
            const t = Math.min(1, (now - t0) / dur);
            const pct = Math.round((1 - Math.pow(1 - t, 3)) * 100);
            entry.els.fill.style.width = pct + '%';
            entry.els.pct.textContent  = pct + '%';
            if (t < 1){ requestAnimationFrame(tick); } else { busy = false; markReady(id); }
          };
          requestAnimationFrame(tick);
        }
      }

      function addFile(file){
        if (ready.length + active.size >= MAX_FILES) return;
        if (file.size > MAX_SIZE) { alert(`${file.name} is larger than ${(MAX_SIZE/1048576)|0} MB.`); return; }
        const okType = allowed.includes(file.type) || /\.(png|jpe?g|pdf|txt|log|docx?|xlsx|csv)$/i.test(file.name);
        if (!okType) { alert(`${file.name} is not an allowed file type.`); return; }

        const signature = sig(file);
        for (const [, v] of active) if (sig(v.file) === signature) return;
        if (ready.some(r => sig(r.file) === signature)) return;

        const id = (self.crypto?.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random().toString(16).slice(2)}`);
        const els = chipFor(file, id);
        active.set(id, { file, els, state:'queued', mode:'pending' });
        setBtnState();
        setTimeout(()=> { ensureWorker(); q.push({ id, file }); pump(); }, 0);
      }

      function addMany(files){ files.forEach((f, i)=> setTimeout(()=> addFile(f), i*40)); }

      addBtn.addEventListener('click', ()=> input.click());
      input.addEventListener('change', ()=>{
        const files = Array.from(input.files || []);
        input.value = '';
        if (!files.length) return;
        addMany(files);
      });

      function reset(){
        if (worker){
          active.forEach((_, id)=> { try { worker.postMessage({cmd:'abort', id}); } catch {} });
        }
        listEl.querySelectorAll('.file-chip').forEach(el => el.remove());
        active.clear();
        ready.length = 0; q.length = 0; busy = false; setBtnState();
      }

      return { get: ()=> ready.map(r => r.file), reset };
    }

    /* ===== Panel controller: mount/unmount forms & wire events ===== */
    document.addEventListener('DOMContentLoaded', () => {
      const emailBtn    = document.getElementById('toggle-email-form');
      const ticketBtn   = document.getElementById('toggle-ticket-form');
      const emailMount  = document.getElementById('email-form-mount');
      const ticketMount = document.getElementById('ticket-form-mount');

      const openEmail = () => {
        if (emailMount.firstElementChild) return;
        emailMount.innerHTML = `
          <div class="form-card">
            <div class="card collapsible__body">
              <h3>Send details to the helpdesk</h3>

              <form id="helpdesk-email-form" class="support-form" novalidate enctype="multipart/form-data">
                <div class="form-grid">
                  <label>
                    <span>Name<span class="req" aria-hidden="true">*</span></span>
                    <input type="text" id="hd-name" name="name" autocomplete="name" required aria-required="true">
                  </label>

                  <label>
                    <span>Company<span class="req" aria-hidden="true">*</span></span>
                    <input type="text" id="hd-company" name="company" autocomplete="organization" required aria-required="true">
                  </label>

                  <label class="full">
                    <span>Email<span class="req" aria-hidden="true">*</span></span>
                    <input type="email" id="hd-email" name="email" autocomplete="email" required aria-required="true">
                  </label>

                  <label class="full">
                    <span>Issue<span class="req" aria-hidden="true">*</span></span>
                    <textarea id="hd-issue" name="issue" rows="5" placeholder="Briefly describe the problem…" required aria-required="true"></textarea>
                  </label>

                  <!-- Attachments widget -->
                  <div class="full attachments">
                    <div class="attach-row">
                      <button type="button" id="hd-add-files" class="attach-btn" title="Add up to 5 files">
                        <svg class="icon-plus" viewBox="0 0 24 24" aria-hidden="true">
                          <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
                          <path d="M12 8v8M8 12h8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Add files
                      </button>
                    </div>
                    <div id="hd-file-list" class="attach-list"></div>
                    <input type="file" id="hd-files" name="attachments[]" multiple hidden
                           accept=".png,.jpg,.jpeg,.pdf,.txt,.log,.doc,.docx,.xlsx,.csv">
                    <div class="attach-note">Up to 5 files, max 5&nbsp;MB each. Allowed: PNG, JPG, PDF, TXT/LOG, DOC/DOCX, XLSX, CSV.</div>
                  </div>

                  <!-- Honeypot -->
                  <input type="text" id="hd-hp" name="website_honeypot" autocomplete="off" tabindex="-1" style="display:none">
                </div>

                <div class="form-actions">
                  <button type="submit" class="btn btn--primary" id="hd-send">Send</button>
                  <button type="button" class="btn btn--outline" id="cancel-email-form">Cancel</button>
                  <span id="hd-status" class="form-status" role="status" aria-live="polite"></span>
                  <span class="form-required-note"><span class="req" aria-hidden="true">*</span> Required</span>
                </div>
              </form>
            </div>
          </div>
        `;

        const form      = document.getElementById('helpdesk-email-form');
        const cancelBtn = document.getElementById('cancel-email-form');
        const statusEl  = document.getElementById('hd-status');
        const sendBtn   = document.getElementById('hd-send');

        function setStatus(cls, html){ statusEl.className = `form-status ${cls} is-visible`; statusEl.innerHTML = html; }
        const setOK   = (m)=> setStatus('form-status--ok', `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20 6L9 17l-5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>${m}`);
        const setErr  = (m)=> setStatus('form-status--error', m);
        const setSpin = ()=> setStatus('form-status--progress', `<span class="spinner" aria-hidden="true"></span>Sending...`);
        const clearStatus = ()=> { statusEl.className='form-status'; statusEl.textContent=''; };

        const widget = setupAttachmentWidget({
          addBtnId: 'hd-add-files',
          inputId : 'hd-files',
          listId  : 'hd-file-list',
          limits  : {
            maxFiles: 5, maxSize : 5 * 1024 * 1024,
            allowed : ['image/png','image/jpeg','application/pdf','text/plain','application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','text/csv']
          }
        });

        function resetFormAndFiles(){ form.reset(); widget.reset(); }

        cancelBtn.addEventListener('click', ()=>{
          resetFormAndFiles();
          clearStatus();
          closeEmail();
        });

        form.addEventListener('submit', async (e)=>{
          e.preventDefault();
          clearStatus();
          if (!form.reportValidity()){ setErr('Please complete all required fields.'); return; }
          sendBtn.disabled = true; cancelBtn.disabled = true; document.getElementById('hd-add-files').disabled = true;
          setSpin();

          const name    = document.getElementById('hd-name').value.trim();
          const company = document.getElementById('hd-company').value.trim();
          const email   = document.getElementById('hd-email').value.trim();
          const issue   = document.getElementById('hd-issue').value.trim();
          const hp      = document.getElementById('hd-hp').value.trim();

          try{
            const fd = new FormData();
            fd.set('name',name); fd.set('company',company); fd.set('email',email); fd.set('issue',issue); fd.set('website_honeypot',hp);
            for (const f of widget.get()) fd.append('attachments[]', f, f.name);
            const resp = await fetch(API('api/helpdesk.php'), { method:'POST', body: fd });
            const text = await resp.text(); let data; try{ data = JSON.parse(text); }catch{ throw new Error('Non-JSON'); }
            if (!resp.ok || !data?.ok) throw new Error(data?.error || 'Send failed');
            setOK('Sent');
            resetFormAndFiles();
          }catch(err){
            console.error('Helpdesk send failed:', err);
            setErr('Send failed — please try again.');
          }finally{
            sendBtn.disabled=false; cancelBtn.disabled=false; document.getElementById('hd-add-files').disabled=false;
          }
        });
      };

      const closeEmail = () => {
        emailMount.replaceChildren();
        emailBtn.setAttribute('aria-expanded', 'false');
      };

      const openTicket = () => {
        if (ticketMount.firstElementChild) return;
        ticketMount.innerHTML = `
          <div class="form-card">
            <div class="card collapsible__body">
              <h3>Open / Manage a Ticket</h3>
              <section class="ticket-portal" aria-label="Ticket portal">
                <div class="tp-tabs" role="tablist" aria-label="Ticket actions">
                  <button class="tp-tab tp-tab--active" data-tp="create" role="tab" aria-selected="true">Open a new ticket</button>
                  <button class="tp-tab" data-tp="lookup" role="tab" aria-selected="false">Check ticket status</button>
                </div>

                <!-- Create -->
                <div class="tp-panel tp-panel--create" role="tabpanel">
                  <form id="tpCreate" novalidate>
                    <div class="tp-grid">
                      <label class="tp-field">
                        <span>Full name <em>*</em></span>
                        <input name="name" type="text" required maxlength="120" autocomplete="name">
                      </label>
                      <label class="tp-field">
                        <span>Company</span>
                        <input name="company" type="text" maxlength="190" autocomplete="organization">
                      </label>
                      <label class="tp-field">
                        <span>Email <em>*</em></span>
                        <input name="email" type="email" required maxlength="190" autocomplete="email">
                      </label>
                      <label class="tp-field">
                        <span>Phone <em>*</em></span>
                        <input name="phone" id="tp-phone" type="tel" autocomplete="tel" inputmode="tel" maxlength="14"
                               pattern="^\\(\\d{3}\\) \\d{3}-\\d{4}$" placeholder="(555) 123-4567" required>
                      </label>
                      <label class="tp-field tp-field--full">
                        <span>Subject <em>*</em></span>
                        <input name="subject" type="text" required maxlength="150">
                      </label>
                      <label class="tp-field tp-field--full">
                        <span>Describe the issue <em>*</em></span>
                        <textarea name="issue" required maxlength="5000" rows="6" placeholder="What happened? When did it start? Error messages?"></textarea>
                      </label>

                      <!-- Attachments widget (no native browse field) -->
                      <div class="tp-field tp-field--full attachments">
                        <div class="attach-row">
                          <button type="button" id="tp-add-files" class="attach-btn" title="Add up to 5 files">
                            <svg class="icon-plus" viewBox="0 0 24 24" aria-hidden="true">
                              <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
                              <path d="M12 8v8M8 12h8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            Add files
                          </button>
                        </div>
                        <div id="tp-file-list" class="attach-list"></div>
                        <input type="file" id="tp-files" name="files[]" multiple hidden
                               accept=".png,.jpg,.jpeg,.pdf,.txt,.log,.doc,.docx,.xlsx,.csv">
                        <div class="attach-note">Up to 5 files, max 5&nbsp;MB each. Allowed: PNG, JPG, PDF, TXT/LOG, DOC/DOCX, XLSX, CSV.</div>
                      </div>
                    </div>

                    <div class="tp-actions">
                      <button type="submit" class="btn btn--primary" id="tpCreateSubmit">Submit ticket</button>
                      <button type="button" class="btn btn--outline" id="tpCreateCancel">Cancel</button>
                      <span class="tp-hint" id="tpCreateHint" role="status" aria-live="polite"></span>
                      <span class="form-required-note"><span class="req" aria-hidden="true">*</span> Required</span>
                    </div>
                  </form>
                </div>

                <!-- Lookup -->
                <div class="tp-panel tp-panel--lookup" role="tabpanel" hidden aria-hidden="true">
                  <form id="tpLookupStart" novalidate>
                    <div class="tp-grid">
                      <label class="tp-field">
                        <span>Requester email <em>*</em></span>
                        <input name="email" type="email" required maxlength="190">
                      </label>
                      <label class="tp-field">
                        <span>Ticket number (optional)</span>
                        <input name="ticket_number" type="text" maxlength="20" placeholder="If you have it">
                      </label>
                    </div>

                    <div class="tp-actions">
                      <button type="submit" class="btn btn--primary">Email me a secure link</button>
                      <button type="button" class="btn btn--outline" id="tpLookupCancel">Cancel</button>
                      <span class="tp-hint" id="tpLookupHint" role="status" aria-live="polite"></span>
                      <span class="form-required-note"><span class="req" aria-hidden="true">*</span> Required</span>
                    </div>
                  </form>

                  <div id="tpLookupResult" class="tp-result" hidden>
                    <h3 class="tp-result__title">Your ticket</h3>
                    <div class="tp-ticket" id="tpTicketCard"></div>

                    <form id="tpAddComment" class="tp-comment" novalidate>
                      <label class="tp-field tp-field--full">
                        <span>Add a public comment (optional)</span>
                        <textarea name="message" rows="4" maxlength="5000"></textarea>
                      </label>
                      <div class="tp-actions">
                        <button type="submit" class="btn">Post comment</button>
                        <span class="tp-hint" id="tpCommentHint" role="status" aria-live="polite"></span>
                      </div>
                    </form>
                  </div>
                </div>
              </section>
            </div>
          </div>
        `;

        const portal = ticketMount.querySelector('.ticket-portal');
        const $$ = (s, el=portal)=> Array.from(el.querySelectorAll(s));
        const $  = (s, el=portal)=> el.querySelector(s);

        // Tabs (no scroll jump)
        $$('.tp-tab').forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            $$('.tp-tab').forEach(b=>b.classList.remove('tp-tab--active'));
            e.currentTarget.classList.add('tp-tab--active');
            const tgt = e.currentTarget.getAttribute('data-tp');
            $$('.tp-panel').forEach(p => p.hidden = !p.classList.contains(`tp-panel--${tgt}`));
          });
        });

        // Attachments for ticket
        const widget = setupAttachmentWidget({
          addBtnId: 'tp-add-files',
          inputId : 'tp-files',
          listId  : 'tp-file-list',
          limits  : {
            maxFiles: 5, maxSize : 5 * 1024 * 1024,
            allowed : ['image/png','image/jpeg','application/pdf','text/plain','application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','text/csv']
          }
        });

        // Cancel buttons
        $('#tpCreateCancel')?.addEventListener('click', ()=>{
          widget.reset();
          $('#tpCreate').reset();
          closeTicket();
        });
        $('#tpLookupCancel')?.addEventListener('click', ()=>{
          $('#tpLookupStart').reset();
          closeTicket();
        });

        // Submit create
        $('#tpCreate')?.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const form = e.currentTarget;
          const hint = $('#tpCreateHint');
          const btn  = $('#tpCreateSubmit');
          hint.textContent = ""; btn.disabled = true;

          const fd = new FormData(form);
          const need = ['name','email','phone','subject','issue'];
          for (const n of need){ if (!(fd.get(n)||'').toString().trim()){ hint.textContent='Please fill out all required fields.'; btn.disabled=false; return; } }

          for (const f of widget.get()) fd.append('files[]', f, f.name);

          try{
            const res = await fetch('/api/tickets/create.php', { method:'POST', body: fd, credentials:'same-origin' });
            const data = await res.json();
            if (!res.ok) throw new Error(data?.error || 'Submission failed.');
            hint.textContent = `Ticket created! #${data.public_ref}. Check your email for confirmation.`;
            form.reset(); widget.reset();
          }catch(err){ hint.textContent = err.message || 'Error creating ticket.'; }
          finally{ btn.disabled=false; }
        });

        // Start lookup (emails magic link)
        $('#tpLookupStart')?.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const fd = new FormData(e.currentTarget);
          const hint = $('#tpLookupHint'); hint.textContent = "";
          try {
            const res = await fetch('/api/tickets/lookup_start.php', { method:'POST', body: fd, credentials:'same-origin' });
            const data = await res.json();
            if (!res.ok) throw new Error(data?.error || 'Request failed.');
            hint.textContent = 'If that email exists for a ticket, a secure link has been sent.';
            e.currentTarget.reset();
          } catch (err) {
            hint.textContent = err.message || 'Error sending link.';
          }
        });

        // Live phone mask
        (function initPhoneMask(){
          const input = document.getElementById('tp-phone');
          if (!input) return;

          function formatUS(digits) {
            const d = digits.slice(0, 10);
            if (d.length === 0) return '';
            if (d.length < 4)  return `(${d}`;
            if (d.length < 7)  return `(${d.slice(0,3)}) ${d.slice(3)}`;
            return `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`;
          }
          function digitCountUpTo(str, pos) {
            let cnt = 0;
            for (let i = 0; i < pos && i < str.length; i++) if (/\d/.test(str[i])) cnt++;
            return cnt;
          }
          function caretPosForDigitIndex(str, digitIndex) {
            if (digitIndex <= 0) return 0;
            let cnt = 0;
            for (let i = 0; i < str.length; i++) {
              if (/\d/.test(str[i])) cnt++;
              if (cnt >= digitIndex) return i + 1;
            }
            return str.length;
          }
          function setValidityForPartial(val) {
            if (val && !/^\(\d{3}\) \d{3}-\d{4}$/.test(val)) {
              input.setCustomValidity('Please enter a full 10-digit US number, e.g. (555) 123-4567.');
            } else {
              input.setCustomValidity('');
            }
          }

          input.addEventListener('input', () => {
            const oldVal = input.value;
            const oldPos = input.selectionStart ?? oldVal.length;
            const digitsBefore = digitCountUpTo(oldVal, oldPos);

            const onlyDigits = oldVal.replace(/\D/g, '').slice(0, 10);
            const newVal = formatUS(onlyDigits);
            const newPos = caretPosForDigitIndex(newVal, digitsBefore);

            if (newVal !== oldVal) {
              input.value = newVal;
              queueMicrotask(() => input.setSelectionRange(newPos, newPos));
            }
            setValidityForPartial(input.value);
          });

          input.addEventListener('blur', () => setValidityForPartial(input.value));
          input.addEventListener('paste', (e) => {
            e.preventDefault();
            const pasted = (e.clipboardData || window.clipboardData).getData('text') || '';
            const digits = pasted.replace(/\D/g, '').slice(0, 10);
            input.value = formatUS(digits);
            const end = input.value.length;
            input.setSelectionRange(end, end);
            setValidityForPartial(input.value);
          });
        })();
      };

      const closeTicket = () => {
        ticketMount.replaceChildren();
        ticketBtn.setAttribute('aria-expanded', 'false');
      };

      // Toggle buttons (mutually exclusive)
      emailBtn?.addEventListener('click', () => {
        const opening = emailBtn.getAttribute('aria-expanded') !== 'true';
        if (opening) {
          if (ticketMount.firstElementChild) closeTicket();
          openEmail();
          emailBtn.setAttribute('aria-expanded', 'true');
        } else {
          closeEmail();
        }
      });

      ticketBtn?.addEventListener('click', () => {
        const opening = ticketBtn.getAttribute('aria-expanded') !== 'true';
        if (opening) {
          if (emailMount.firstElementChild) closeEmail();
          openTicket();
          ticketBtn.setAttribute('aria-expanded', 'true');
        } else {
          closeTicket();
        }
      });

      // Deep-link (?tkn=...) opens ticket->lookup
      (async () => {
        const url = new URL(window.location.href);
        const token = url.searchParams.get("tkn");
        if (!token) return;
        if (!ticketMount.firstElementChild) { openTicket(); ticketBtn?.setAttribute('aria-expanded','true'); }
        const portal = ticketMount.querySelector('.ticket-portal');
        const lookupTab = portal.querySelector('.tp-tab[data-tp="lookup"]');
        if (lookupTab) lookupTab.click();
        try {
          const res = await fetch("/api/tickets/lookup_fetch.php?tkn=" + encodeURIComponent(token), { credentials:"same-origin" });
          const data = await res.json();
          if (!res.ok) throw new Error(data?.error || "Could not load ticket.");
          portal.querySelector("#tpLookupResult").hidden = false;
          portal.querySelector("#tpTicketCard").innerHTML = `
            <div class="tp-card-line"><strong>Ticket #</strong> ${data.public_ref}</div>
            <div class="tp-card-line"><strong>Subject</strong> ${data.subject}</div>
            <div class="tp-card-line"><strong>Status</strong> ${data.status}</div>
            <div class="tp-card-line"><strong>Last Update</strong> ${data.updated_at}</div>
            <div class="tp-thread">
              ${data.thread.map(m => `
                <div class="tp-msg">
                  <div class="tp-msg-meta">${m.when} — ${m.author}${m.public ? '' : ' (private)'}</div>
                  <div class="tp-msg-body">${m.body_html}</div>
                </div>`).join("")}
            </div>
          `;
          const commentForm = portal.querySelector('#tpAddComment');
          commentForm?.addEventListener('submit', async (e)=>{
            e.preventDefault();
            const hint = portal.querySelector('#tpCommentHint'); hint.textContent='';
            const fd = new FormData(commentForm); fd.append('tkn', token);
            try{
              const r = await fetch('/api/tickets/add_comment.php', { method:'POST', body: fd, credentials:'same-origin' });
              const out = await r.json();
              if (!r.ok) throw new Error(out?.error || 'Failed to post comment.');
              hint.textContent = 'Comment posted.'; commentForm.reset();
            }catch(err){ hint.textContent = err.message || 'Error posting comment.'; }
          });
        } catch {/* silent */}
      })();
    });
  </script>
</body>
</html>
