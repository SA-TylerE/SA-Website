<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Support | System Alternatives</title>
  <meta name="description" content="Get help fast. Call the helpdesk or start a secure remote session with Splashtop SOS." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/base.css" />
  <link rel="stylesheet" href="/assets/css/support.css" />
  <script src="/assets/js/includes.js" defer></script>
</head>
<body>
  <!-- Shared header -->
  <div data-include="/partials/header.html"></div>

  <main>
    <!-- Hero -->
    <section class="hero hero--light hero--bg hero--enhanced support-hero">
      <div class="container hero__inner">
        <div class="hero__copy">
          <h1>Support</h1>
          <p>Need help right now? Call our helpdesk to start a secure remote session.</p>
        </div>
      </div>
    </section>

    <!-- Helpdesk -->
    <section class="section" id="helpdesk">
      <div class="container">
        <article class="card helpdesk-card">
          <div class="helpdesk-card__intro">
            <h2>Contact the Helpdesk</h2>
            <p class="lead">Speak with a tech or send us an email—whatever's convenient.</p>
          </div>

          <div class="helpdesk-actions">
            <a class="btn btn--primary" href="tel:+1-503-878-7000">Call/Text 503-878-7000</a>

            <button
              type="button"
              id="toggle-email-form"
              class="btn btn--outline"
              aria-expanded="false"
              aria-controls="email-form-panel">
              Email Helpdesk
            </button>

            <button
              type="button"
              id="toggle-ticket-form"
              class="btn btn--outline"
              aria-expanded="false"
              aria-controls="ticket-form-panel">
              Open a Ticket
            </button>
          </div>
        </article>

        <!-- Collapsible email form panel -->
        <div id="email-form-panel" class="collapsible" hidden>
          <div class="card collapsible__body">
            <h3>Send details to the helpdesk</h3>

            <form id="helpdesk-email-form" class="support-form" novalidate enctype="multipart/form-data">
              <div class="form-grid">
                <label>
                  <span>Name<span class="req" aria-hidden="true">*</span></span>
                  <input type="text" id="hd-name" name="name" autocomplete="name" required aria-required="true">
                </label>

                <label>
                  <span>Company<span class="req" aria-hidden="true">*</span></span>
                  <input type="text" id="hd-company" name="company" autocomplete="organization" required aria-required="true">
                </label>

                <label class="full">
                  <span>Email<span class="req" aria-hidden="true">*</span></span>
                  <input type="email" id="hd-email" name="email" autocomplete="email" required aria-required="true">
                </label>

                <label class="full">
                  <span>Issue<span class="req" aria-hidden="true">*</span></span>
                  <textarea id="hd-issue" name="issue" rows="5" placeholder="Briefly describe the problem…" required aria-required="true"></textarea>
                </label>

                <!-- Attachments widget -->
                <div class="full attachments">
                  <div class="attach-row">
                    <button type="button" id="hd-add-files" class="attach-btn" title="Add up to 5 files">
                      <svg class="icon-plus" viewBox="0 0 24 24" aria-hidden="true">
                        <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
                        <path d="M12 8v8M8 12h8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                      Add files
                    </button>
                  </div>
                  <div id="hd-file-list" class="attach-list"></div>
                  <input type="file" id="hd-files" name="attachments[]" multiple hidden
                         accept=".png,.jpg,.jpeg,.pdf,.txt,.log,.doc,.docx,.xlsx,.csv">
                  <div class="attach-note">Up to 5 files, max 5&nbsp;MB each. Allowed: PNG, JPG, PDF, TXT/LOG, DOC/DOCX, XLSX, CSV.</div>
                </div>

                <!-- Honeypot -->
                <input type="text" id="hd-hp" name="website_honeypot" autocomplete="off" tabindex="-1" style="display:none">
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn--primary" id="hd-send">Send</button>
                <button type="button" class="btn btn--outline" id="cancel-email-form">Cancel</button>
                <span id="hd-status" class="form-status" role="status" aria-live="polite"></span>
                <span class="form-required-note"><span class="req" aria-hidden="true">*</span> Required</span>
              </div>
            </form>
          </div>
        </div>

      </div>
    </section>

    <!-- Ticket Portal (collapsible like Email) -->
    <section class="section" id="tickets">
      <div class="container">
        <div id="ticket-form-panel" class="collapsible" hidden>
          <div class="card collapsible__body">
            <h3>Open / Manage a Ticket</h3>

            <section class="ticket-portal" aria-label="Ticket portal">
              <div class="tp-tabs" role="tablist" aria-label="Ticket actions">
                <button class="tp-tab tp-tab--active" data-tp="create" role="tab" aria-selected="true">Open a new ticket</button>
                <button class="tp-tab" data-tp="lookup" role="tab" aria-selected="false">Check ticket status</button>
              </div>

              <!-- Create -->
              <div class="tp-panel tp-panel--create" role="tabpanel">
                <form id="tpCreate" enctype="multipart/form-data" novalidate>
                  <div class="tp-grid">
                    <label class="tp-field">
                      <span>Full name <em>*</em></span>
                      <input name="name" type="text" required maxlength="120" autocomplete="name">
                    </label>
                    <label class="tp-field">
                      <span>Company (optional)</span>
                      <input name="company" type="text" maxlength="190" autocomplete="organization">
                    </label>

                    <label class="tp-field tp-field--full">
                      <span>Email <em>*</em></span>
                      <input name="email" type="email" required maxlength="190" autocomplete="email">
                    </label>

                    <label class="tp-field tp-field--full">
                      <span>Phone <em>*</em></span>
                      <input name="phone" type="tel" inputmode="tel" autocomplete="tel"
                             pattern="^[0-9+()\\-\\s]{7,25}$" required
                             placeholder="digits, spaces, + ( ) -">
                    </label>

                    <label class="tp-field tp-field--full">
                      <span>Subject <em>*</em></span>
                      <input name="subject" type="text" required maxlength="150">
                    </label>

                    <label class="tp-field tp-field--full">
                      <span>Describe the issue <em>*</em></span>
                      <textarea name="issue" required maxlength="5000" rows="6" placeholder="What happened? When did it start? Error messages?"></textarea>
                    </label>

                    <!-- Attachments (same widget style as email) -->
                    <div class="tp-field tp-field--full attachments">
                      <div class="attach-row">
                        <button type="button" id="tp-add-files" class="attach-btn" title="Add up to 5 files">
                          <svg class="icon-plus" viewBox="0 0 24 24" aria-hidden="true">
                            <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
                            <path d="M12 8v8M8 12h8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                          </svg>
                          Add files
                        </button>
                      </div>
                      <div id="tp-file-list" class="attach-list"></div>
                      <input type="file" id="tp-files" name="files[]" multiple hidden
                             accept=".png,.jpg,.jpeg,.pdf,.txt,.log,.doc,.docx,.xlsx,.csv">
                      <div class="attach-note">Up to 5 files, max 15&nbsp;MB each; allowed: PNG, JPG, PDF, TXT/LOG, DOC/DOCX, XLSX, CSV.</div>
                    </div>
                  </div>

                  <div class="tp-actions">
                    <button type="submit" class="btn btn--primary" id="tpCreateSubmit">Submit ticket</button>
                    <button type="button" class="btn btn--outline" id="tpCreateCancel">Cancel</button>
                    <span class="tp-hint" id="tpCreateHint" role="status" aria-live="polite"></span>
                  </div>
                </form>
              </div>

              <!-- Lookup -->
              <div class="tp-panel tp-panel--lookup" role="tabpanel" hidden aria-hidden="true">
                <form id="tpLookupStart" novalidate>
                  <div class="tp-grid">
                    <label class="tp-field tp-field--full">
                      <span>Requester email <em>*</em></span>
                      <input name="email" type="email" required maxlength="190">
                    </label>
                    <label class="tp-field tp-field--full">
                      <span>Ticket number (optional)</span>
                      <input name="ticket_number" type="text" maxlength="20" placeholder="If you have it">
                    </label>
                  </div>

                  <div class="tp-actions">
                    <button type="submit" class="btn btn--primary">Email me a secure link</button>
                    <button type="button" class="btn btn--outline" id="tpLookupCancel">Cancel</button>
                    <span class="tp-hint" id="tpLookupHint" role="status" aria-live="polite"></span>
                  </div>
                </form>

                <!-- Magic-link result -->
                <div id="tpLookupResult" class="tp-result" hidden>
                  <h3 class="tp-result__title">Your ticket</h3>
                  <div class="tp-ticket" id="tpTicketCard"></div>

                  <form id="tpAddComment" class="tp-comment" novalidate>
                    <label class="tp-field tp-field--full">
                      <span>Add a public comment (optional)</span>
                      <textarea name="message" rows="4" maxlength="5000"></textarea>
                    </label>
                    <div class="tp-actions">
                      <button type="submit" class="btn">Post comment</button>
                      <span class="tp-hint" id="tpCommentHint" role="status" aria-live="polite"></span>
                    </div>
                  </form>
                </div>
              </div>
            </section>
          </div>
        </div>
      </div>
    </section>

    <!-- Remote support (Splashtop SOS) -->
    <section class="section" id="remote">
      <div class="container remote-grid">
        <article class="card download-card">
          <div class="download-header">
            <a id="download-button" class="btn btn--primary" href="#" aria-label="Download Splashtop SOS">
              <img id="platform-icon" class="platform-icon" src="" alt="" />
              <span id="button-text">Splashtop SOS</span>
            </a>
            <div class="download-meta">
              <div id="platform-message" class="platform-status">Detecting your platform…</div>
              <div class="platform-note">Auto-detected; you can choose a different platform below.</div>
            </div>
          </div>

          <div class="override-wrapper">
            <strong>Choose a different platform</strong>
            <div id="platform-buttons" class="override-group" aria-label="Manual platform selection"></div>
          </div>

          <noscript>
            <div class="notice">
              <p><strong>JavaScript is disabled.</strong> Use the direct links:</p>
              <ul>
                <li><a href="https://download.splashtop.com/sos/SplashtopSOS.exe">Windows</a></li>
                <li><a href="https://download.splashtop.com/sos/SplashtopSOS.dmg">macOS</a></li>
                <li><a href="https://play.google.com/store/apps/details?id=com.splashtop.sos">Android</a></li>
                <li><a href="https://apps.apple.com/app/splashtop-sos/id1230853703">iOS</a></li>
              </ul>
            </div>
          </noscript>
        </article>

        <div class="card howto-card">
          <h2>How it works</h2>
          <ol class="howto-steps">
            <li><strong>Download & open the app.</strong> Click the button for your platform above.</li>
            <li><strong>Provide the 9-digit code.</strong> Share the one-time SOS code with your technician.</li>
            <li><strong>We connect securely.</strong> Allow access if prompted; you can end any time.</li>
          </ol>
        </div>
      </div>
    </section>
  </main>

  <!-- Shared footer -->
  <div data-include="/partials/footer.html"></div>

  <!-- Scripts -->
  <script>
    /* ===== Splashtop platform detection (unchanged) ===== */
    document.addEventListener("DOMContentLoaded", function () {
      const downloadBtn = document.getElementById("download-button");
      const platformMsg = document.getElementById("platform-message");
      const platformIcon = document.getElementById("platform-icon");
      const buttonText = document.getElementById("button-text");
      const platformBtnsContainer = document.getElementById("platform-buttons");

      const downloads = {
        windows:{name:"Windows",url:"https://download.splashtop.com/sos/SplashtopSOS.exe",icon:"https://img.icons8.com/ios-filled/50/000000/windows8.png"},
        mac:{name:"macOS",url:"https://download.splashtop.com/sos/SplashtopSOS.dmg",icon:"https://img.icons8.com/ios-filled/50/000000/mac-os.png"},
        android:{name:"Android",url:"https://play.google.com/store/apps/details?id=com.splashtop.sos",icon:"https://img.icons8.com/ios-filled/50/000000/android-os.png"},
        ios:{name:"iOS",url:"https://apps.apple.com/app/splashtop-sos/id1230853703",icon:"https://img.icons8.com/ios-filled/50/000000/ios-logo.png"}
      };

      function detectOS(){
        const ua = navigator.userAgent || navigator.vendor || window.opera;
        if (/windows/i.test(ua)) return "windows";
        if (/macintosh|mac os x/i.test(ua)) return "mac";
        if (/android/i.test(ua)) return "android";
        if (/iphone|ipad|ipod/i.test(ua)) return "ios";
        return "unknown";
      }
      function markSelected(osKey){
        document.querySelectorAll('.override-download-btn')
          .forEach(function(b){ b.classList.toggle('selected', b.dataset.key === osKey); });
      }
      function updateDownload(osKey, manual){
        if (manual === void 0) manual = false;
        const p = downloads[osKey]; if (!p) return;
        downloadBtn.href = p.url;
        platformIcon.src = p.icon;
        platformIcon.alt = p.name + " icon";
        buttonText.textContent = "Splashtop SOS";
        platformMsg.textContent = "Download the " + p.name + " version" + (manual ? " (selected manually)" : "") + ".";
        downloadBtn.style.display = "inline-flex";
        markSelected(osKey);
      }
      function buildOverrideButtons(){
        for (let key in downloads){
          const p = downloads[key];
          const btn = document.createElement("button");
          btn.className = "override-download-btn";
          btn.type = "button";
          btn.dataset.key = key;
          btn.innerHTML = '<img src="'+p.icon+'" alt="'+p.name+'"> ' + p.name;
          btn.addEventListener("click", function(){ updateDownload(key, true); });
          platformBtnsContainer.appendChild(btn);
        }
      }

      const detectedOS = detectOS();
      buildOverrideButtons();
      if (downloads[detectedOS]) updateDownload(detectedOS);
      else { platformMsg.textContent = "We couldn't detect your platform. Please choose one below."; downloadBtn.style.display = "none"; }
    });

    const API = (p) => `${window.location.origin}/${String(p).replace(/^\/+/, '')}`;

    /* ===== Shared attachment worker/widget (email + tickets) ===== */
    function createIngestWorker(){
      const src = `
        const jobs = new Map();
        self.onmessage = (e)=>{
          const {cmd, id, file, chunk=524288} = e.data||{};
          if (cmd==='ingest'){
            jobs.set(id, {cancel:false});
            try{
              const reader = new FileReaderSync();
              let offset = 0, total = file.size||1;
              while(offset < total){
                const job = jobs.get(id);
                if (!job || job.cancel){ postMessage({id,type:'aborted'}); jobs.delete(id); return; }
                const end = Math.min(offset+chunk, total);
                reader.readAsArrayBuffer(file.slice(offset,end));
                offset = end;
                postMessage({id,type:'progress',pct:Math.round((offset/total)*100)});
              }
              postMessage({id,type:'done'}); jobs.delete(id);
            }catch(err){
              postMessage({id,type:'error',message:String(err&&err.message||err)}); jobs.delete(id);
            }
          }else if(cmd==='abort'){ const j = jobs.get(id); if (j) j.cancel = true; }
        };
      `;
      const blob = new Blob([src], {type:'application/javascript'});
      const url  = URL.createObjectURL(blob);
      const w    = new Worker(url);
      w._revokeURL = ()=> URL.revokeObjectURL(url);
      return w;
    }

    function setupAttachmentWidget({ addBtnId, inputId, listId, limits }){
      const addBtn = document.getElementById(addBtnId);
      const input  = document.getElementById(inputId);
      const listEl = document.getElementById(listId);
      const ready = [];
      const active = new Map();
      const q = [];
      let busy = false;
      let worker = null;
      const MAX_FILES = limits.maxFiles;
      const MAX_SIZE  = limits.maxSize;
      const allowed   = limits.allowed;
      const fmtMB = n => (n/(1024*1024)).toFixed(2)+' MB';
      const sig = f => `${f.name}|${f.size}|${f.lastModified}`;

      function setBtnState(){
        const count = ready.length + active.size;
        addBtn.disabled = count >= MAX_FILES;
        addBtn.title = addBtn.disabled ? `Limit reached (${MAX_FILES} files)` : `Add up to ${MAX_FILES} files`;
      }
      function chipFor(file, id){
        const chip = document.createElement('span');
        chip.className = 'file-chip is-loading';
        chip.dataset.id = id;
        chip.innerHTML =
          '<span class="file-chip__name" title="'+file.name+'">'+file.name+'</span>' +
          '<span class="file-chip__size">(' + fmtMB(file.size) + ')</span>' +
          '<span class="file-chip__bar" aria-hidden="true"><span data-fill style="width:0%"></span></span>' +
          '<span class="file-chip__pct" data-pct>0%</span>' +
          '<button class="file-chip__remove" type="button" aria-label="Remove '+file.name+'">×</button>';
        listEl.appendChild(chip);
        return {
          chip,
          fill: chip.querySelector('[data-fill]'),
          pct: chip.querySelector('[data-pct]'),
          removeBtn: chip.querySelector('.file-chip__remove')
        };
      }
      function markReady(id){
        const entry = active.get(id); if (!entry) return;
        entry.els.fill.style.width = '100%';
        entry.els.pct.textContent = '100%';
        entry.els.chip.classList.remove('is-loading');
        entry.els.chip.classList.add('is-ready');
        ready.push({id, file: entry.file});
        active.delete(id);
        setBtnState(); pump();
      }
      function removeId(id){
        const entry = active.get(id);
        if (entry){
          if (entry.mode === 'worker' && worker){ try { worker.postMessage({cmd:'abort', id}); } catch (e) {} }
          try { entry.els.chip.remove(); } catch (e) {}
          active.delete(id);
        } else {
          const idx = ready.findIndex(r => r.id === id);
          if (idx >= 0){
            try {
              const el = listEl.querySelector('.file-chip[data-id="'+id+'"]');
              if (el) el.remove();
            } catch (e) {}
            ready.splice(idx,1);
          }
        }
        setBtnState(); pump();
      }
      listEl.addEventListener('click', (e)=>{
        const btn = e.target.closest('.file-chip__remove'); if (!btn) return;
        const chip = btn.closest('.file-chip'); if (!chip) return;
        removeId(chip.dataset.id);
      });
      function ensureWorker(){
        if (worker) return;
        try{
          worker = createIngestWorker();
          worker.onmessage = (ev)=>{
            const data = ev.data || {};
            const id = data.id, type = data.type, pct = data.pct;
            const entry = active.get(id); if (!entry) return;
            if (type === 'progress'){ entry.els.fill.style.width = pct + '%'; entry.els.pct.textContent = pct + '%'; }
            else if (type === 'done'){ busy=false; markReady(id); }
            else if (type === 'aborted'){ busy=false; removeId(id); }
            else if (type === 'error'){ busy=false; removeId(id); }
          };
          worker.onerror = ()=>{ busy=false; };
        }catch(e){ worker=null; }
      }
      function pump(){
        if (busy || q.length===0) return;
        const job = q.shift();
        const entry = active.get(job.id); if (!entry){ pump(); return; }
        if (worker){
          busy = true; entry.state='working'; entry.mode='worker';
          setTimeout(()=>{ try { worker.postMessage({cmd:'ingest', id:job.id, file:job.file, chunk:512*1024}); } catch (e) { busy=false; removeId(job.id); }}, 0);
        }else{
          const dur = Math.max(600, Math.min(2200, 450 + (job.file.size/(1024*1024))*350));
          const t0 = performance.now(); entry.state='working'; entry.mode='sim'; busy=true;
          const tick = (now)=>{
            if (!active.has(job.id)) { busy=false; pump(); return; }
            const t = Math.min(1, (now - t0) / dur);
            const pct = Math.round((1 - Math.pow(1 - t, 3)) * 100);
            entry.els.fill.style.width = pct + '%';
            entry.els.pct.textContent  = pct + '%';
            if (t < 1){ requestAnimationFrame(tick); } else { busy=false; markReady(job.id); }
          };
          requestAnimationFrame(tick);
        }
      }
      function addFile(file){
        if (ready.length + active.size >= MAX_FILES) return;
        if (file.size > MAX_SIZE) { alert(file.name + ' is larger than ' + (MAX_SIZE/1048576).toFixed(0) + ' MB.'); return; }
        const okType = allowed.includes(file.type) || /\.(png|jpe?g|pdf|txt|log|docx?|xlsx|csv)$/i.test(file.name);
        if (!okType) { alert(file.name + ' is not an allowed file type.'); return; }
        const signature = sig(file);
        for (const [,v] of active) if (sig(v.file) === signature) return;
        if (ready.some(r => sig(r.file) === signature)) return;

        const id = (self.crypto && self.crypto.randomUUID ? crypto.randomUUID() : (Date.now() + '-' + Math.random().toString(16).slice(2)));
        const els = chipFor(file, id);
        active.set(id, { file, els, state:'queued', mode:'pending' });
        setBtnState();
        setTimeout(()=> { ensureWorker(); q.push({ id, file }); pump(); }, 0);
      }
      function addMany(files){ files.forEach((f,i)=> setTimeout(()=> addFile(f), i*40)); }

      addBtn.addEventListener('click', ()=> input.click());
      input.addEventListener('change', ()=>{
        const files = Array.from(input.files||[]); input.value=''; if (!files.length) return; addMany(files);
      });

      function reset(){
        if (worker){ active.forEach((_,id)=> { try{ worker.postMessage({cmd:'abort', id}); }catch(e){}; }); }
        listEl.querySelectorAll('.file-chip').forEach(el=>el.remove());
        active.clear(); ready.length=0; q.length=0; busy=false; setBtnState();
      }
      return { get: ()=> ready.map(r => r.file), reset };
    }

    /* ===== Email: open/close + submit ===== */
    (function(){
      const toggleBtn = document.getElementById('toggle-email-form');
      const panel     = document.getElementById('email-form-panel');
      const form      = document.getElementById('helpdesk-email-form');
      const cancelBtn = document.getElementById('cancel-email-form');
      const statusEl  = document.getElementById('hd-status');
      const sendBtn   = document.getElementById('hd-send');
      let isAnimating = false, fadeTimer = null, resetTimer = null;

      const cancelTimers = ()=>{ if (fadeTimer) clearTimeout(fadeTimer); if (resetTimer) clearTimeout(resetTimer); fadeTimer = resetTimer = null; };
      const setStatus = (cls, html)=>{ cancelTimers(); statusEl.className = 'form-status ' + cls + ' is-visible'; statusEl.innerHTML = html; };
      const setStatusOK    = (m)=>{ setStatus('form-status--ok', '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20 6L9 17l-5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'+m); fadeTimer=setTimeout(()=>{ statusEl.classList.remove('is-visible'); resetTimer=setTimeout(()=>{ statusEl.className='form-status'; statusEl.textContent=''; },300);},7000); };
      const setStatusErr   = (m)=> setStatus('form-status--error', m);
      const setStatusSend  = ()=> setStatus('form-status--progress', '<span class="spinner" aria-hidden="true"></span>Sending...');
      const clearStatus    = ()=>{ cancelTimers(); statusEl.classList.remove('is-visible'); resetTimer=setTimeout(()=>{ statusEl.className='form-status'; statusEl.textContent=''; },250); };

      const openPanel = ()=>{
        if (isAnimating) return; isAnimating = true;
        panel.hidden=false; panel.classList.add('is-open'); panel.style.height='0px'; panel.style.opacity='0'; panel.offsetHeight;
        panel.style.height = panel.scrollHeight + 'px'; panel.style.opacity='1'; toggleBtn.setAttribute('aria-expanded','true');
      };
      const closePanel = ()=>{
        if (isAnimating) return; isAnimating = true;
        panel.style.height = panel.scrollHeight + 'px'; panel.offsetHeight;
        panel.style.height = '0px'; panel.style.opacity='0'; toggleBtn.setAttribute('aria-expanded','false');
      };
      panel.addEventListener('transitionend', (e)=>{
        if (e.propertyName !== 'height') return;
        const isOpen = toggleBtn.getAttribute('aria-expanded') === 'true';
        if (isOpen){ panel.style.height='auto'; } else { panel.classList.remove('is-open'); panel.hidden=true; panel.style.height=''; }
        isAnimating = false;
      });
      toggleBtn.addEventListener('click', ()=>{
        const expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
        if (!expanded && window.saPanels && window.saPanels.ticket && window.saPanels.ticket.isOpen && window.saPanels.ticket.isOpen()) window.saPanels.ticket.close();
        expanded ? closePanel() : openPanel();
      });

      // expose for ticket panel
      window.saPanels = window.saPanels || {};
      window.saPanels.email = { open: openPanel, close: closePanel, isOpen: ()=> toggleBtn.getAttribute('aria-expanded')==='true' };

      // Attachments (email)
      const widget = setupAttachmentWidget({
        addBtnId: 'hd-add-files',
        inputId : 'hd-files',
        listId  : 'hd-file-list',
        limits  : {
          maxFiles: 5, maxSize : 5 * 1024 * 1024,
          allowed : ['image/png','image/jpeg','application/pdf','text/plain','application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','text/csv']
        }
      });

      function resetFormAndFiles(){ form.reset(); widget.reset(); }

      cancelBtn.addEventListener('click', ()=>{ resetFormAndFiles(); clearStatus(); closePanel(); });

      form.addEventListener('submit', async (e)=>{
        e.preventDefault(); clearStatus();
        if (!form.reportValidity()){ setStatusErr('Please complete all required fields.'); return; }
        sendBtn.disabled = true; cancelBtn.disabled = true; document.getElementById('hd-add-files').disabled = true;
        setStatusSend();

        const name    = (document.getElementById('hd-name').value||'').trim();
        const company = (document.getElementById('hd-company').value||'').trim();
        const email   = (document.getElementById('hd-email').value||'').trim();
        const issue   = (document.getElementById('hd-issue').value||'').trim();
        const hp      = (document.getElementById('hd-hp').value||'').trim();

        try{
          const fd = new FormData();
          fd.set('name',name);
          fd.set('company',company);
          fd.set('email',email);
          fd.set('issue',issue);
          fd.set('website_honeypot',hp);
          for (const f of widget.get()) fd.append('attachments[]', f, f.name);
          const resp = await fetch(API('api/helpdesk.php'), { method:'POST', body: fd });
          const text = await resp.text(); let data; try{ data = JSON.parse(text); }catch(e){ throw new Error('Non-JSON'); }
          if (!resp.ok || !data || !data.ok) throw new Error((data && data.error) || 'Send failed');
          setStatusOK('Sent'); resetFormAndFiles();
        }catch(err){ console.error('Helpdesk send failed:', err); setStatusErr('Send failed — please try again.'); }
        finally{ sendBtn.disabled=false; cancelBtn.disabled=false; document.getElementById('hd-add-files').disabled=false; }
      });
    })();

    /* ===== Ticket portal: open/close + tabs + API + magic link ===== */
    (function () {
      const $ = (s, el=document)=>el.querySelector(s);
      const $$ = (s, el=document)=>Array.from(el.querySelectorAll(s));

      const toggleBtn = document.getElementById('toggle-ticket-form');
      const panel     = document.getElementById('ticket-form-panel');
      const portal    = panel.querySelector('.ticket-portal');

      let animating = false;

      function openPanel(){
        if (animating) return; animating = true;
        panel.hidden=false; panel.classList.add('is-open'); panel.style.height='0px'; panel.style.opacity='0'; panel.offsetHeight;
        panel.style.height = panel.scrollHeight + 'px'; panel.style.opacity='1'; toggleBtn.setAttribute('aria-expanded','true');
      }
      function closePanel(){
        if (animating) return; animating = true;
        panel.style.height = panel.scrollHeight + 'px'; panel.offsetHeight;
        panel.style.height = '0px'; panel.style.opacity='0'; toggleBtn.setAttribute('aria-expanded','false');
      }
      panel.addEventListener('transitionend', (e)=>{
        if (e.propertyName !== 'height') return;
        const isOpen = toggleBtn.getAttribute('aria-expanded') === 'true';
        if (isOpen){ panel.style.height='auto'; } else { panel.classList.remove('is-open'); panel.hidden=true; panel.style.height=''; }
        animating = false;
      });

      // Mutual exclusivity with Email panel
      toggleBtn.addEventListener('click', ()=>{
        const expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
        if (!expanded && window.saPanels && window.saPanels.email && window.saPanels.email.isOpen && window.saPanels.email.isOpen()) window.saPanels.email.close();
        expanded ? closePanel() : openPanel();
      });

      // Expose for cross-control
      window.saPanels = window.saPanels || {};
      window.saPanels.ticket = { open: openPanel, close: closePanel, isOpen: ()=> toggleBtn.getAttribute('aria-expanded')==='true' };

      // Tabs (no scrolling)
      $$('.tp-tab', portal).forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          $$('.tp-tab', portal).forEach(b=>b.classList.remove('tp-tab--active'));
          e.currentTarget.classList.add('tp-tab--active');
          const tgt = e.currentTarget.getAttribute('data-tp');
          $$('.tp-panel', portal).forEach(p => p.hidden = !p.classList.contains('tp-panel--' + tgt));
        });
      });

      // Attachments (ticket create)
      const tpWidget = setupAttachmentWidget({
        addBtnId: 'tp-add-files',
        inputId : 'tp-files',
        listId  : 'tp-file-list',
        limits  : {
          maxFiles: 5, maxSize : 15 * 1024 * 1024,
          allowed : ['image/png','image/jpeg','application/pdf','text/plain','application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','text/csv']
        }
      });

      // Create ticket submit
      $('#tpCreate', portal)?.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const form = e.currentTarget;
        const hint = $('#tpCreateHint', portal);
        const btn  = $('#tpCreateSubmit', portal);
        hint.textContent = ''; btn.disabled = true;

        const fd = new FormData(form);
        const need = ['name','email','phone','subject','issue'];
        for (const n of need){ if (!(fd.get(n)||'').toString().trim()){ hint.textContent='Please fill out all required fields.'; btn.disabled=false; return; } }

        // append files from widget (replaces native input)
        for (const f of tpWidget.get()) fd.append('files[]', f, f.name);

        try {
          const res = await fetch('/api/tickets/create.php', { method:'POST', body: fd, credentials: 'same-origin' });
          const data = await res.json();
          if (!res.ok) throw new Error((data && data.error) || 'Submission failed.');
          hint.textContent = 'Ticket created! #' + data.public_ref + '. Check your email for confirmation.';
          form.reset(); tpWidget.reset();
        } catch (err) {
          hint.textContent = err.message || 'Error creating ticket.';
        } finally {
          btn.disabled = false;
        }
      });

      // Ticket Create cancel
      $('#tpCreateCancel', portal)?.addEventListener('click', ()=>{
        $('#tpCreate', portal)?.reset();
        tpWidget.reset();
        window.saPanels.ticket.close();
      });

      // Lookup start
      $('#tpLookupStart', portal)?.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(e.currentTarget);
        const hint = $('#tpLookupHint', portal);
        hint.textContent = '';
        try {
          const res = await fetch('/api/tickets/lookup_start.php', { method:'POST', body: fd, credentials:'same-origin' });
          const data = await res.json();
          if (!res.ok) throw new Error((data && data.error) || 'Request failed.');
          hint.textContent = 'If that email exists for a ticket, a secure link has been sent.';
          e.currentTarget.reset();
        } catch (err) {
          hint.textContent = err.message || 'Error sending link.';
        }
      });

      // Lookup cancel
      $('#tpLookupCancel', portal)?.addEventListener('click', ()=>{
        $('#tpLookupStart', portal)?.reset();
        window.saPanels.ticket.close();
      });

      // Deep-link magic token (?tkn=...)
      (async () => {
        const url = new URL(window.location.href);
        const token = url.searchParams.get('tkn');
        if (!token) return;

        if (!window.saPanels.ticket.isOpen()) window.saPanels.ticket.open();
        const lookupTab = portal.querySelector('.tp-tab[data-tp="lookup"]');
        if (lookupTab) lookupTab.click();

        try {
          const res = await fetch('/api/tickets/lookup_fetch.php?tkn=' + encodeURIComponent(token), { credentials:'same-origin' });
          const data = await res.json();
          if (!res.ok) throw new Error((data && data.error) || 'Could not load ticket.');

          $('#tpLookupResult', portal).hidden = false;

          $('#tpTicketCard', portal).innerHTML =
            '<div class="tp-card-line"><strong>Ticket #</strong> ' + data.public_ref + '</div>' +
            '<div class="tp-card-line"><strong>Subject</strong> ' + data.subject + '</div>' +
            '<div class="tp-card-line"><strong>Status</strong> ' + data.status + '</div>' +
            '<div class="tp-card-line"><strong>Last Update</strong> ' + data.updated_at + '</div>' +
            '<div class="tp-thread">' +
              data.thread.map(function(m){
                return '<div class="tp-msg">' +
                         '<div class="tp-msg-meta">' + m.when + ' — ' + m.author + (m.public ? '' : ' (private)') + '</div>' +
                         '<div class="tp-msg-body">' + m.body_html + '</div>' +
                       '</div>';
              }).join('') +
            '</div>';

          $('#tpAddComment', portal)?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const hint = $('#tpCommentHint', portal); hint.textContent = '';
            const fd = new FormData(e.currentTarget);
            fd.append('tkn', token);
            try {
              const res = await fetch('/api/tickets/add_comment.php', { method:'POST', body: fd, credentials:'same-origin' });
              const out = await res.json();
              if (!res.ok) throw new Error((out && out.error) || 'Failed to post comment.');
              hint.textContent = 'Comment posted.';
              e.currentTarget.reset();
            } catch (err) {
              hint.textContent = err.message || 'Error posting comment.';
            }
          });

          panel.scrollIntoView({behavior:'smooth', block:'start'});
        } catch (err) {
          /* silent to avoid existence leak */
        }
      })();
    })();
  </script>
</body>
</html>
