<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Support | System Alternatives</title>
  <meta name="description" content="Get help fast. Call the helpdesk or start a secure remote session with Splashtop SOS." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/base.css" />
  <link rel="stylesheet" href="assets/css/support.css" />
  <script src="assets/js/includes.js" defer></script>
</head>
<body>
  <!-- Shared header -->
  <div data-include="partials/header.html"></div>

  <main>
    <!-- Hero -->
    <section class="hero hero--light hero--bg hero--enhanced support-hero">
      <div class="container hero__inner">
        <div class="hero__copy">
          <h1>Support</h1>
          <p>Need help right now? Call our helpdesk to start a secure remote session.</p>
        </div>
      </div>
    </section>

    <!-- Helpdesk -->
    <section class="section" id="helpdesk">
      <div class="container">
        <article class="card helpdesk-card">
          <div class="helpdesk-card__intro">
            <h2>Contact the Helpdesk</h2>
            <p class="lead">Speak with a tech or send us an email—whatever's convenient.</p>
          </div>

          <div class="helpdesk-actions">
            <a class="btn btn--primary" href="tel:+1-503-878-7000">Call/Text 503-878-7000</a>
            <button
              type="button"
              id="toggle-email-form"
              class="btn btn--outline"
              aria-expanded="false"
              aria-controls="email-form-panel">
              Email Helpdesk
            </button>
            <a class="btn btn--outline" href="#" aria-disabled="true" title="Web ticketing coming soon">
              Open a Ticket
            </a>
          </div>
        </article>

        <!-- Collapsible email form panel -->
        <div id="email-form-panel" class="collapsible" hidden>
          <div class="card collapsible__body">
            <h3>Send details to the helpdesk</h3>

            <form id="helpdesk-email-form" class="support-form" novalidate enctype="multipart/form-data">
              <div class="form-grid">
                <label>
                  <span>Name<span class="req" aria-hidden="true">*</span></span>
                  <input type="text" id="hd-name" name="name" autocomplete="name" required aria-required="true">
                </label>

                <label>
                  <span>Company<span class="req" aria-hidden="true">*</span></span>
                  <input type="text" id="hd-company" name="company" autocomplete="organization" required aria-required="true">
                </label>

                <label class="full">
                  <span>Email<span class="req" aria-hidden="true">*</span></span>
                  <input type="email" id="hd-email" name="email" autocomplete="email" required aria-required="true">
                </label>

                <label class="full">
                  <span>Issue<span class="req" aria-hidden="true">*</span></span>
                  <textarea id="hd-issue" name="issue" rows="5" placeholder="Briefly describe the problem…" required aria-required="true"></textarea>
                </label>

                <!-- Attachments widget -->
                <div class="full attachments">
                  <div class="attach-row">
                    <button type="button" id="hd-add-files" class="attach-btn" title="Add up to 5 files">
                      <svg class="icon-plus" viewBox="0 0 24 24" aria-hidden="true">
                        <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
                        <path d="M12 8v8M8 12h8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                      Add files
                    </button>
                  </div>
                  <div id="hd-file-list" class="attach-list"></div>
                  <input type="file" id="hd-files" name="attachments[]" multiple hidden
                         accept=".png,.jpg,.jpeg,.pdf,.txt,.log,.doc,.docx,.xlsx,.csv">
                  <div class="attach-note">Up to 5 files, max 5&nbsp;MB each. Allowed: PNG, JPG, PDF, TXT/LOG, DOC/DOCX, XLSX, CSV.</div>
                </div>

                <!-- Honeypot -->
                <input type="text" id="hd-hp" name="website_honeypot" autocomplete="off" tabindex="-1" style="display:none">
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn--primary" id="hd-send">Send</button>
                <button type="button" class="btn btn--outline" id="cancel-email-form">Cancel</button>
                <span id="hd-status" class="form-status" role="status" aria-live="polite"></span>
                <span class="form-required-note"><span class="req" aria-hidden="true">*</span> Required</span>
              </div>
            </form>
          </div>
        </div>

      </div>
    </section>

    <!-- Remote support (Splashtop SOS) -->
    <section class="section" id="remote">
      <div class="container remote-grid">
        <article class="card download-card">
          <div class="download-header">
            <a id="download-button" class="btn btn--primary" href="#" aria-label="Download Splashtop SOS">
              <img id="platform-icon" class="platform-icon" src="" alt="" />
              <span id="button-text">Splashtop SOS</span>
            </a>
            <div class="download-meta">
              <div id="platform-message" class="platform-status">Detecting your platform…</div>
              <div class="platform-note">Auto-detected; you can choose a different platform below.</div>
            </div>
          </div>

          <div class="override-wrapper">
            <strong>Choose a different platform</strong>
            <div id="platform-buttons" class="override-group" aria-label="Manual platform selection"></div>
          </div>

          <noscript>
            <div class="notice">
              <p><strong>JavaScript is disabled.</strong> Use the direct links:</p>
              <ul>
                <li><a href="https://download.splashtop.com/sos/SplashtopSOS.exe">Windows</a></li>
                <li><a href="https://download.splashtop.com/sos/SplashtopSOS.dmg">macOS</a></li>
                <li><a href="https://play.google.com/store/apps/details?id=com.splashtop.sos">Android</a></li>
                <li><a href="https://apps.apple.com/app/splashtop-sos/id1230853703">iOS</a></li>
              </ul>
            </div>
          </noscript>
        </article>

        <div class="card howto-card">
          <h2>How it works</h2>
          <ol class="howto-steps">
            <li><strong>Download & open the app.</strong> Click the button for your platform above.</li>
            <li><strong>Provide the 9-digit code.</strong> Share the one-time SOS code with your technician.</li>
            <li><strong>We connect securely.</strong> Allow access if prompted; you can end any time.</li>
          </ol>
        </div>
      </div>
    </section>
  </main>

  <!-- Shared footer -->
  <div data-include="partials/footer.html"></div>

  <!-- Scripts -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const downloadBtn = document.getElementById("download-button");
      const platformMsg = document.getElementById("platform-message");
      const platformIcon = document.getElementById("platform-icon");
      const buttonText = document.getElementById("button-text");
      const platformBtnsContainer = document.getElementById("platform-buttons");

      const downloads = {
        windows:{name:"Windows",url:"https://download.splashtop.com/sos/SplashtopSOS.exe",icon:"https://img.icons8.com/ios-filled/50/000000/windows8.png"},
        mac:{name:"macOS",url:"https://download.splashtop.com/sos/SplashtopSOS.dmg",icon:"https://img.icons8.com/ios-filled/50/000000/mac-os.png"},
        android:{name:"Android",url:"https://play.google.com/store/apps/details?id=com.splashtop.sos",icon:"https://img.icons8.com/ios-filled/50/000000/android-os.png"},
        ios:{name:"iOS",url:"https://apps.apple.com/app/splashtop-sos/id1230853703",icon:"https://img.icons8.com/ios-filled/50/000000/ios-logo.png"}
      };

      function detectOS(){
        const ua = navigator.userAgent || navigator.vendor || window.opera;
        if (/windows/i.test(ua)) return "windows";
        if (/macintosh|mac os x/i.test(ua)) return "mac";
        if (/android/i.test(ua)) return "android";
        if (/iphone|ipad|ipod/i.test(ua)) return "ios";
        return "unknown";
      }
      function markSelected(osKey){
        document.querySelectorAll('.override-download-btn')
          .forEach(b => b.classList.toggle('selected', b.dataset.key === osKey));
      }
      function updateDownload(osKey, manual = false){
        const p = downloads[osKey]; if (!p) return;
        downloadBtn.href = p.url;
        platformIcon.src = p.icon;
        platformIcon.alt = p.name + " icon";
        buttonText.textContent = "Splashtop SOS";
        platformMsg.textContent = `Download the ${p.name} version${manual ? " (selected manually)" : ""}.`;
        downloadBtn.style.display = "inline-flex";
        markSelected(osKey);
      }
      function buildOverrideButtons(){
        for (let key in downloads){
          const p = downloads[key];
          const btn = document.createElement("button");
          btn.className = "override-download-btn";
          btn.type = "button";
          btn.dataset.key = key;
          btn.innerHTML = `<img src="${p.icon}" alt="${p.name}"> ${p.name}`;
          btn.addEventListener("click", () => updateDownload(key, true));
          platformBtnsContainer.appendChild(btn);
        }
      }

      const detectedOS = detectOS();
      buildOverrideButtons();
      if (downloads[detectedOS]) updateDownload(detectedOS);
      else { platformMsg.textContent = "We couldn't detect your platform. Please choose one below."; downloadBtn.style.display = "none"; }
    });

    const API = (p) => `${window.location.origin}/${String(p).replace(/^\/+/, '')}`;

    // ========= Inline Web Worker (reads files off the main thread with FileReaderSync) =========
    function createIngestWorker(){
      const workerSrc = `
        const jobs = new Map();
        function readFileInChunks(id, file, chunk){
          try{
            const reader = new FileReaderSync();
            let offset = 0;
            const total = file.size || 1;
            while (offset < total){
              const job = jobs.get(id);
              if (!job || job.cancel) { self.postMessage({id, type:'aborted'}); jobs.delete(id); return; }
              const end = Math.min(offset + chunk, total);
              const slice = file.slice(offset, end);
              reader.readAsArrayBuffer(slice); // blocks worker thread only
              offset = end;
              const pct = Math.round((offset/total)*100);
              self.postMessage({id, type:'progress', pct, loaded: offset, total});
            }
            self.postMessage({id, type:'done'});
            jobs.delete(id);
          }catch(err){
            self.postMessage({id, type:'error', message: String(err && err.message || err)});
            jobs.delete(id);
          }
        }
        self.onmessage = (e)=>{
          const {cmd, id, file, chunk=524288} = e.data || {};
          if (cmd === 'ingest'){
            jobs.set(id, {cancel:false});
            readFileInChunks(id, file, chunk);
          } else if (cmd === 'abort'){
            const j = jobs.get(id);
            if (j) j.cancel = true;
          }
        };
      `;
      const blob = new Blob([workerSrc], { type: 'application/javascript' });
      const url  = URL.createObjectURL(blob);
      const w    = new Worker(url);
      // Clean up blob URL when worker terminates
      w.addEventListener('error', ()=> URL.revokeObjectURL(url));
      w.addEventListener('messageerror', ()=> URL.revokeObjectURL(url));
      return w;
    }

    // ========= Attachment widget using the worker for per-file progress =========
    function setupAttachmentWidget({ addBtnId, inputId, listId, limits }){
      const addBtn = document.getElementById(addBtnId);
      const input  = document.getElementById(inputId);
      const listEl = document.getElementById(listId);

      // Ready-to-send files
      let readyFiles = [];
      // Map of active chips
      const active = new Map(); // id -> { els, file, remove, cancel, mode: 'worker'|'sim' }

      // Single worker + simple queue so we don't overwhelm memory
      let worker = null;
      let queue = [];         // [{id, file}]
      let busy  = false;

      const MAX_FILES = limits.maxFiles;
      const MAX_SIZE  = limits.maxSize;
      const allowed   = limits.allowed;

      const fmtMB = (n)=> (n/(1024*1024)).toFixed(2)+' MB';
      const fkey  = (f)=> `${f.name}|${f.size}|${f.lastModified}`;

      function setBtnState(){
        const count = readyFiles.length + active.size;
        addBtn.disabled = count >= MAX_FILES;
        addBtn.title = addBtn.disabled ? `Limit reached (${MAX_FILES} files)` : `Add up to ${MAX_FILES} files`;
      }

      function createChip(f){
        const chip = document.createElement('span');
        chip.className = 'file-chip is-loading';
        chip.innerHTML = `
          <span class="file-chip__name" title="${f.name}">${f.name}</span>
          <span class="file-chip__size">(${fmtMB(f.size)})</span>
          <span class="file-chip__bar" aria-hidden="true"><span data-fill></span></span>
          <span class="file-chip__pct" data-pct>0%</span>
          <button class="file-chip__remove" type="button" aria-label="Remove ${f.name}">×</button>
        `;
        listEl.appendChild(chip);
        return {
          chip,
          fill: chip.querySelector('[data-fill]'),
          pct:  chip.querySelector('[data-pct]'),
          removeBtn: chip.querySelector('.file-chip__remove'),
        };
      }

      function finishReady(id){
        const entry = active.get(id);
        if (!entry) return;
        entry.els.chip.classList.remove('is-loading');
        entry.els.chip.classList.add('is-ready');
        readyFiles.push(entry.file);
        active.delete(id);
        setBtnState();
        pumpQueue(); // proceed to next file, if any
      }

      function removeEntry(id){
        const entry = active.get(id);
        if (!entry) return;
        try { entry.remove(); } catch {}
        active.delete(id);
        setBtnState();
      }

      // ---- worker pipeline ----
      function ensureWorker(){
        if (worker) return;
        try{
          worker = createIngestWorker();
          worker.onmessage = (e)=>{
            const {id, type, pct} = e.data || {};
            const entry = active.get(id);
            if (!entry) return;
            if (type === 'progress'){
              if (typeof pct === 'number'){
                entry.els.fill.style.width = pct + '%';
                entry.els.pct.textContent  = pct + '%';
              }
            } else if (type === 'done'){
              entry.els.fill.style.width = '100%';
              entry.els.pct.textContent  = '100%';
              busy = false;
              finishReady(id);
            } else if (type === 'aborted'){
              busy = false;
              removeEntry(id);
            } else if (type === 'error'){
              busy = false;
              // Fallback gracefully: remove chip (or we could switch to simulated)
              removeEntry(id);
            }
          };
          worker.onerror = ()=>{ busy = false; /* fallback on next pump */ };
        }catch(e){
          worker = null; // fallback to simulation
        }
      }

      function pumpQueue(){
        if (busy) return;
        if (queue.length === 0) return;
        const job = queue.shift();
        // If worker OK, use it; otherwise simulate
        if (worker){
          busy = true;
          try{
            worker.postMessage({ cmd:'ingest', id: job.id, file: job.file, chunk: 512*1024 });
          }catch(e){
            busy = false;
            // Worker rejected (e.g., structured clone blocked) -> simulate
            startSim(job.id, job.file);
          }
        } else {
          startSim(job.id, job.file);
        }
      }

      // ---- simulated fallback (no file reads) ----
      const simState = new Map(); // id -> { rafId, start, dur, canceled }
      function startSim(id, file){
        // ~0.6–2.2s based on size
        const dur = Math.max(600, Math.min(2200, 450 + (file.size/(1024*1024))*350));
        const t0  = performance.now();
        const entry = active.get(id);
        if (!entry) return;
        simState.set(id, { rafId: 0, start: t0, dur, canceled: false });

        const tick = (now)=>{
          const st = simState.get(id);
          if (!st || st.canceled) { simState.delete(id); return; }
          const t = Math.min(1, (now - st.start) / st.dur);
          const pct = Math.round((1 - Math.pow(1 - t, 3)) * 100);
          entry.els.fill.style.width = pct + '%';
          entry.els.pct.textContent  = pct + '%';

          if (t < 1){
            st.rafId = requestAnimationFrame(tick);
          } else {
            simState.delete(id);
            finishReady(id);
          }
        };
        simState.get(id).rafId = requestAnimationFrame(tick);
      }

      // ---- public flow ----
      function addFile(f){
        if ((readyFiles.length + active.size) >= MAX_FILES) return;
        if (f.size > MAX_SIZE){ alert(`${f.name} is larger than 5 MB.`); return; }
        const okType = allowed.includes(f.type) || /\.(png|jpe?g|pdf|txt|log|docx?|xlsx|csv)$/i.test(f.name);
        if (!okType){ alert(`${f.name} is not an allowed file type.`); return; }

        const id = crypto.randomUUID ? crypto.randomUUID() : (Date.now()+'-'+Math.random().toString(16).slice(2));
        // Prevent dup by name/size/mtime across active/ready
        const signature = f.name + '|' + f.size + '|' + f.lastModified;
        if ([...active.values(), ...readyFiles].some(v => (v.file ? (v.file.name+'|'+v.file.size+'|'+v.file.lastModified) : (v.name+'|'+v.size+'|'+v.lastModified)) === signature)) {
          return;
        }

        const els = createChip(f);

        const remove = ()=>{
          // cancel worker or sim if running
          if (active.has(id)){
            if (worker) try { worker.postMessage({ cmd:'abort', id }); } catch {}
            const sim = simState.get(id);
            if (sim){ sim.canceled = true; cancelAnimationFrame(sim.rafId); simState.delete(id); }
            els.chip.remove();
          }
        };

        // wire up remove button immediately
        els.removeBtn.addEventListener('click', ()=>{
          // If in ready list, delete from there; if active, abort the job
          const idx = readyFiles.findIndex(x => x === f);
          if (idx >= 0) readyFiles.splice(idx, 1);
          remove();
          active.delete(id);
          setBtnState();
          pumpQueue(); // keep queue moving if we canceled the current job
        });

        active.set(id, { els, file: f, remove, mode: 'worker' });
        setBtnState();

        // enqueue and start if idle
        queue.push({ id, file: f });
        ensureWorker();
        pumpQueue();
      }

      function addMany(list){
        // Stagger queueing very lightly to keep UI snappy
        list.forEach((f, i)=> setTimeout(()=> addFile(f), i * 40));
      }

      addBtn.addEventListener('click', ()=> input.click());
      input.addEventListener('change', ()=>{
        const picked = Array.from(input.files || []);
        input.value = '';
        if (!picked.length) return;
        addMany(picked);
      });

      function reset(){
        // Abort active worker job
        if (worker){
          active.forEach((_, id)=> { try { worker.postMessage({cmd:'abort', id}); } catch {} });
        }
        // Cancel sims
        simState.forEach((st, id)=> { st.canceled = true; cancelAnimationFrame(st.rafId); });
        simState.clear();

        // Clear UI
        active.forEach(({remove})=> { try { remove(); } catch {} });
        active.clear();
        readyFiles = [];
        listEl.innerHTML = '';
        input.value = '';
        queue = [];
        busy = false;
        setBtnState();
      }

      // Init state
      setBtnState();

      return {
        get: ()=> readyFiles.slice(),
        reset
      };
    }

    (function(){
      const toggleBtn = document.getElementById('toggle-email-form');
      const panel     = document.getElementById('email-form-panel');
      const form      = document.getElementById('helpdesk-email-form');
      const cancelBtn = document.getElementById('cancel-email-form');
      const statusEl  = document.getElementById('hd-status');
      const sendBtn   = document.getElementById('hd-send');

      let isAnimating = false;

      // Status timers
      let fadeTimer = null;
      let resetTimer = null;

      function cancelStatusTimers(){
        if (fadeTimer)  { clearTimeout(fadeTimer);  fadeTimer = null; }
        if (resetTimer) { clearTimeout(resetTimer); resetTimer = null; }
      }

      function setStatusSending(){
        cancelStatusTimers();
        statusEl.className = 'form-status form-status--progress is-visible';
        statusEl.innerHTML = `<span class="spinner" aria-hidden="true"></span>Sending...`;
      }
      function setStatusOK(msg){
        cancelStatusTimers();
        statusEl.className = 'form-status form-status--ok is-visible';
        statusEl.innerHTML =
          `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20 6L9 17l-5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>${msg}`;
        fadeTimer = setTimeout(()=>{
          statusEl.classList.remove('is-visible');
          resetTimer = setTimeout(()=>{
            statusEl.className = 'form-status';
            statusEl.textContent = '';
          }, 300);
        }, 7000);
      }
      function setStatusError(msg){
        cancelStatusTimers();
        statusEl.className = 'form-status form-status--error is-visible';
        statusEl.textContent = msg;
      }
      function clearStatus(){
        cancelStatusTimers();
        statusEl.classList.remove('is-visible');
        resetTimer = setTimeout(()=>{
          statusEl.className = 'form-status';
          statusEl.textContent = '';
        }, 250);
      }

      function openPanel(){
        if (isAnimating) return;
        isAnimating = true;
        panel.hidden = false;
        panel.classList.add('is-open');
        panel.style.height = '0px';
        panel.style.opacity = '0';
        panel.offsetHeight;
        panel.style.height = panel.scrollHeight + 'px';
        panel.style.opacity = '1';
        toggleBtn.setAttribute('aria-expanded','true');
      }
      function closePanel(){
        if (isAnimating) return;
        isAnimating = true;
        panel.style.height = panel.scrollHeight + 'px';
        panel.offsetHeight;
        panel.style.height = '0px';
        panel.style.opacity = '0';
        toggleBtn.setAttribute('aria-expanded','false');
      }
      panel.addEventListener('transitionend', (e)=>{
        if (e.propertyName !== 'height') return;
        const isOpen = toggleBtn.getAttribute('aria-expanded') === 'true';
        if (isOpen){
          panel.style.height = 'auto';
        }else{
          panel.classList.remove('is-open');
          panel.hidden = true;
          panel.style.height = '';
        }
        isAnimating = false;
      });
      toggleBtn.addEventListener('click', ()=>{
        const expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
        expanded ? closePanel() : openPanel();
      });

      // Attachments (worker-based ingestion progress)
      const widget = setupAttachmentWidget({
        addBtnId: 'hd-add-files',
        inputId : 'hd-files',
        listId  : 'hd-file-list',
        limits  : {
          maxFiles: 5,
          maxSize : 5 * 1024 * 1024, // 5 MB
          allowed : [
            'image/png','image/jpeg','application/pdf','text/plain','application/msword',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','text/csv'
          ]
        }
      });

      function resetFormAndFiles(){
        form.reset();
        widget.reset();
      }

      cancelBtn.addEventListener('click', ()=>{
        resetFormAndFiles();
        clearStatus();
        closePanel();
      });

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        clearStatus();

        if (!form.reportValidity()){
          setStatusError('Please complete all required fields.');
          return;
        }

        // Disable while sending
        sendBtn.disabled = true;
        cancelBtn.disabled = true;
        const addBtn = document.getElementById('hd-add-files');
        addBtn.disabled = true;

        setStatusSending();

        const name    = (document.getElementById('hd-name').value||'').trim();
        const company = (document.getElementById('hd-company').value||'').trim();
        const email   = (document.getElementById('hd-email').value||'').trim();
        const issue   = (document.getElementById('hd-issue').value||'').trim();
        const hp      = (document.getElementById('hd-hp').value||'').trim();

        try{
          const fd = new FormData();
          fd.set('name',name);
          fd.set('company',company);
          fd.set('email',email);
          fd.set('issue',issue);
          fd.set('website_honeypot',hp);
          for (const f of widget.get()) fd.append('attachments[]', f, f.name);

          const resp = await fetch(API('api/helpdesk.php'), { method:'POST', body: fd });
          const text = await resp.text();
          let data; try{ data = JSON.parse(text); }catch{ throw new Error('Non-JSON'); }
          if (!resp.ok || !data?.ok) throw new Error(data?.error || 'Send failed');

          setStatusOK('Sent');
          resetFormAndFiles();
        }catch(err){
          console.error('Helpdesk send failed:', err);
          setStatusError('Send failed — please try again.');
        }finally{
          sendBtn.disabled = false;
          cancelBtn.disabled = false;
          document.getElementById('hd-add-files').disabled = false;
        }
      });
    })();
  </script>
</body>
</html>
