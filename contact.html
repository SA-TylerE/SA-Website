<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contact | System Alternatives</title>
  <meta name="description" content="Call, text, or email System Alternatives. Mailing address and office map (visits by appointment)." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/base.css" />
  <link rel="stylesheet" href="/assets/css/contact.css" />
  <script src="/assets/js/includes.js" defer></script>
</head>
<body>
  <!-- Shared header -->
  <div data-include="/partials/header.html"></div>

  <!-- Hero -->
  <section class="hero hero--light hero--bg hero--enhanced hero--compact hero--singlecol contact-hero">
    <div class="container hero__inner">
      <div class="hero__copy">
        <span class="kicker">Contact</span>
        <h1>We‚Äôre here to help.</h1>
        <p class="lead">Call, text, or email‚Äîwhatever‚Äôs easiest. Our office map is provided for scheduled visits or deliveries.</p>
        <div class="hero__cta">
          <a class="btn btn--primary" href="tel:+15038788000">Call 503-878-8000</a>
        </div>
        <ul class="hero__badges">
          <li>Fast, friendly support</li>
          <li>Portland‚ÄìVancouver & beyond</li>
        </ul>
      </div>
    </div>
  </section>

  <main>
    <!-- Contact options -->
    <section class="section" id="contact-options">
      <div class="container">
        <h2>Get in touch</h2>
        <div class="grid grid-3 contact-cards">
          <article class="card contact-card no-lift">
            <h3>üìû Call</h3>
            <p class="muted">Give us a call, we're here to help.</p>
            <a class="btn btn--primary" href="tel:+15038788000">Call 503-878-8000</a>
          </article>

          <article class="card contact-card no-lift">
            <h3>üí¨ Text</h3>
            <p class="muted">Quick questions? Send a text.</p>
            <a class="btn btn--outline" href="sms:+15038787000">Text 503-878-7000</a>
          </article>

          <article class="card contact-card no-lift">
            <h3>‚úâÔ∏è Email</h3>
            <p class="muted">We'll get back to you.</p>
            <button type="button"
                    id="toggle-contact-form"
                    class="btn btn--outline"
                    aria-expanded="false"
                    aria-controls="contact-form-panel">
              Email us
            </button>
          </article>
        </div>

        <!-- Collapsible email form -->
        <div id="contact-form-panel" class="collapsible" hidden>
          <div class="card collapsible__body">
            <h3>Send us a message</h3>

            <form id="contact-email-form" class="support-form" novalidate>
              <div class="form-grid">
                <label>
                  <span>Name<span class="req" aria-hidden="true">*</span></span>
                  <input type="text" id="ct-name" name="name" autocomplete="name" required aria-required="true">
                </label>

                <label>
                  <span>Company</span>
                  <input type="text" id="ct-company" name="company" autocomplete="organization">
                </label>

                <label>
                  <span>Email<span class="req" aria-hidden="true">*</span></span>
                  <input type="email" id="ct-email" name="email" autocomplete="email" required aria-required="true">
                </label>

                <label>
                  <span>Phone<span class="req" aria-hidden="true">*</span></span>
                  <input type="tel" id="ct-phone" name="phone" autocomplete="tel" inputmode="tel" maxlength="14" pattern="^\(\d{3}\) \d{3}-\d{4}$" placeholder="(555) 123-4567" required aria-required="true">
                </label>

                <label class="full">
                  <span>Subject<span class="req" aria-hidden="true">*</span></span>
                  <input type="text" id="ct-subject" name="subject" required aria-required="true">
                </label>

                <label class="full">
                  <span>Message<span class="req" aria-hidden="true">*</span></span>
                  <textarea id="ct-message" name="message" rows="6" required aria-required="true"></textarea>
                </label>

                <!-- Honeypot -->
                <input type="text" id="ct-hp" name="website_honeypot" autocomplete="off" tabindex="-1" style="display:none">
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn--primary" id="ct-send">Send</button>
                <button type="button" class="btn btn--outline" id="cancel-contact-form">Cancel</button>
                <span id="ct-status" class="form-status" role="status" aria-live="polite"></span>
                <span class="form-required-note"><span class="req" aria-hidden="true">*</span> Required</span>
              </div>
            </form>
          </div>
        </div>

      </div>
    </section>

    <!-- Mailing address + office map -->
    <section class="section section--alt" id="visit">
      <div class="container">
        <div class="grid grid-2 contact-visit">
          <div class="visit-info">
            <h2 class="visit-title">
              Mailing address <span class="muted small-note">(office visits by appointment)</span>
            </h2>
            <address class="mailing-address">
              <strong>System Alternatives</strong><br>
              PO Box 152<br>
              Scappoose, OR 97056
            </address>
          </div>

          <div class="map-wrap">
            <iframe
              title="Map to System Alternatives office"
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"
              src="https://www.google.com/maps?q=36061+Construction+Way,+St+Helens,+Oregon+97051&output=embed">
            </iframe>
          </div>

          <div class="map-cta">
            <a id="open-maps-btn" class="btn btn--primary only-mobile" href="#" rel="noopener">
              Open in Maps
            </a>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Shared footer -->
  <div data-include="/partials/footer.html"></div>

  <!-- Scripts -->
  <script>
    (function(){
      const btn = document.getElementById('open-maps-btn'); if (!btn) return;
      const officeAddr = "36061 Construction Way, St. Helens, OR 97051";
      const ua = navigator.userAgent || "";
      const isIOS = /iPhone|iPad|iPod/i.test(ua);
      const isAndroid = /Android/i.test(ua);

      let href = "https://www.google.com/maps?q=" + encodeURIComponent(officeAddr);
      if (isIOS) href = "http://maps.apple.com/?q=" + encodeURIComponent(officeAddr);
      else if (isAndroid) href = "geo:0,0?q=" + encodeURIComponent(officeAddr);
      btn.setAttribute("href", href);
    })();
  </script>

  <!-- Phone input live formatter -->
  <script>
    (function initPhoneMask(){
      const input = document.getElementById('ct-phone');
      if (!input) return;

      function formatUS(digits) {
        const d = digits.slice(0, 10);
        if (d.length === 0) return '';
        if (d.length < 4)  return `(${d}`;
        if (d.length < 7)  return `(${d.slice(0,3)}) ${d.slice(3)}`;
        return `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`;
      }
      function digitCountUpTo(str, pos) {
        let cnt = 0;
        for (let i = 0; i < pos && i < str.length; i++) if (/\d/.test(str[i])) cnt++;
        return cnt;
      }
      function caretPosForDigitIndex(str, digitIndex) {
        if (digitIndex <= 0) return 0;
        let cnt = 0;
        for (let i = 0; i < str.length; i++) {
          if (/\d/.test(str[i])) cnt++;
          if (cnt >= digitIndex) return i + 1;
        }
        return str.length;
      }
      function setValidityForPartial(val) {
        if (val && !/^\(\d{3}\) \d{3}-\d{4}$/.test(val)) {
          input.setCustomValidity('Please enter a full 10-digit US number, e.g. (555) 123-4567.');
        } else {
          input.setCustomValidity('');
        }
      }

      input.addEventListener('input', () => {
        const oldVal = input.value;
        const oldPos = input.selectionStart ?? oldVal.length;
        const digitsBefore = digitCountUpTo(oldVal, oldPos);

        const onlyDigits = oldVal.replace(/\D/g, '').slice(0, 10);
        const newVal = formatUS(onlyDigits);
        const newPos = caretPosForDigitIndex(newVal, digitsBefore);

        if (newVal !== oldVal) {
          input.value = newVal;
          queueMicrotask(() => input.setSelectionRange(newPos, newPos));
        }
        setValidityForPartial(input.value);
      });

      input.addEventListener('blur', () => {
        setValidityForPartial(input.value);
      });

      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const pasted = (e.clipboardData || window.clipboardData).getData('text') || '';
        const digits = pasted.replace(/\D/g, '').slice(0, 10);
        input.value = formatUS(digits);
        const end = input.value.length;
        input.setSelectionRange(end, end);
        setValidityForPartial(input.value);
      });
    })();
  </script>

  <script>
    const API = (p) => `${window.location.origin}/${String(p).replace(/^\/+/, '')}`;

    (function(){
      const toggleBtn = document.getElementById('toggle-contact-form');
      const panel     = document.getElementById('contact-form-panel');
      const form      = document.getElementById('contact-email-form');
      const cancelBtn = document.getElementById('cancel-contact-form');
      const statusEl  = document.getElementById('ct-status');
      const sendBtn   = document.getElementById('ct-send');

      let isAnimating = false;

      // Status timers
      let fadeTimer = null;
      let resetTimer = null;

      function cancelStatusTimers(){
        if (fadeTimer)  { clearTimeout(fadeTimer);  fadeTimer = null; }
        if (resetTimer) { clearTimeout(resetTimer); resetTimer = null; }
      }

      function setStatusSending(){
        cancelStatusTimers();
        statusEl.className = 'form-status form-status--progress is-visible';
        statusEl.innerHTML = `<span class="spinner" aria-hidden="true"></span>Sending...`;
      }
      function setStatusOK(msg){
        cancelStatusTimers();
        statusEl.className = 'form-status form-status--ok is-visible';
        statusEl.innerHTML =
          `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20 6L9 17l-5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>${msg}`;
        fadeTimer = setTimeout(()=>{
          statusEl.classList.remove('is-visible');
          resetTimer = setTimeout(()=>{
            statusEl.className = 'form-status';
            statusEl.textContent = '';
          }, 300);
        }, 7000);
      }
      function setStatusError(msg){
        cancelStatusTimers();
        statusEl.className = 'form-status form-status--error is-visible';
        statusEl.textContent = msg;
      }
      function clearStatus(){
        cancelStatusTimers();
        statusEl.classList.remove('is-visible');
        resetTimer = setTimeout(()=>{
          statusEl.className = 'form-status';
          statusEl.textContent = '';
        }, 250);
      }

      function openPanel(){
        if (isAnimating) return;
        isAnimating = true;
        panel.hidden = false;
        panel.classList.add('is-open');
        panel.style.height = '0px';
        panel.style.opacity = '0';
        panel.offsetHeight;
        panel.style.height = panel.scrollHeight + 'px';
        panel.style.opacity = '1';
        toggleBtn.setAttribute('aria-expanded','true');
      }
      function closePanel(){
        if (isAnimating) return;
        isAnimating = true;
        panel.style.height = panel.scrollHeight + 'px';
        panel.offsetHeight;
        panel.style.height = '0px';
        panel.style.opacity = '0';
        toggleBtn.setAttribute('aria-expanded','false');
      }
      panel.addEventListener('transitionend', (e)=>{
        if (e.propertyName !== 'height') return;
        const isOpen = toggleBtn.getAttribute('aria-expanded') === 'true';
        if (isOpen){
          panel.style.height = 'auto';
        }else{
          panel.classList.remove('is-open');
          panel.hidden = true;
          panel.style.height = '';
        }
        isAnimating = false;
      });
      toggleBtn.addEventListener('click', ()=>{
        const expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
        expanded ? closePanel() : openPanel();
      });

      cancelBtn.addEventListener('click', ()=>{
        form.reset();
        clearStatus();
        closePanel();
      });

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        clearStatus();

        if (!form.reportValidity()){
          setStatusError('Please complete all required fields.');
          return;
        }

        sendBtn.disabled = true;
        cancelBtn.disabled = true;
        setStatusSending();

        const fd = new FormData(form);

        try{
          const resp = await fetch(API('api/contact.php'), { method:'POST', body: fd });
          const text = await resp.text();
          let data; try{ data = JSON.parse(text); } catch { throw new Error('Non-JSON'); }
          if (!resp.ok || !data?.ok) throw new Error(data?.error || 'Send failed');

          setStatusOK('Sent');
          form.reset();
        }catch(err){
          console.error('Contact send failed:', err);
          setStatusError('Send failed ‚Äî please try again.');
        }finally{
          sendBtn.disabled = false;
          cancelBtn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>
